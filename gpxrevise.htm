<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>çš®å…‹æ•è·¯å¾‘ä¿®æ”¹å™¨ Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --p-green: #2f9e44; --p-blue: #1971c2; --p-orange: #f08c00; --p-red: #e03131; --p-dark: #343a40; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f8f9fa; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; overflow: hidden; }
        
        #menu-btn { position: fixed; top: 15px; left: 15px; z-index: 10006; background: white; border: 2px solid var(--p-green); border-radius: 10px; padding: 8px 12px; cursor: pointer; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #side-menu { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: white; z-index: 10005; transition: 0.3s; box-shadow: 2px 0 15px rgba(0,0,0,0.2); padding-top: 70px; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 18px 25px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; color: var(--p-dark); text-decoration: none; display: block; }

        #controls { width: 100%; height: 100%; padding: 20px; padding-top: 70px; background: white; overflow-y: auto; }
        .is-hidden { display: none !important; }
        
        /* æ¨¡å¼åˆ‡æ›å™¨ */
        .mode-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .mode-card { background: #f1f3f5; padding: 15px 5px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s; font-weight: bold; font-size: 14px; }
        .mode-card.active { background: white; border-color: var(--p-green); color: var(--p-green); box-shadow: 0 4px 12px rgba(47,158,68,0.2); }

        .card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #dee2e6; border-left: 6px solid var(--p-green); }
        
        /* åœ°åœ–ä½ˆå±€ */
        #map-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: none; background: white; }
        #map { width: 100%; height: 100%; }
        
        /* å´é‚Šæ¬„åˆ†æ®µé¸æ“‡ */
        #session-sidebar { position: absolute; top: 100px; left: 15px; z-index: 2000; width: 150px; display: flex; flex-direction: column; gap: 8px; }
        .session-btn { background: rgba(255,255,255,0.9); border: 2px solid var(--p-blue); padding: 10px; border-radius: 10px; font-weight: bold; font-size: 12px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .session-btn.active { background: var(--p-blue); color: white; }

        .map-btn-group { position: absolute; top: 20px; right: 15px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .map-ctrl-btn { background: rgba(0,0,0,0.85); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* åº•éƒ¨ç·¨è¼¯å™¨ */
        #bottom-editor { position: absolute; bottom: 30px; left: 5%; width: 90%; background: white; z-index: 10001; border: 2.5px solid var(--p-green); border-radius: 20px; padding: 15px; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
        .action-row { display: flex; gap: 6px; margin-top: 8px; }
        .btn-act { flex: 1; padding: 12px 2px; border-radius: 10px; border: none; font-weight: bold; font-size: 11px; cursor: pointer; }

        /* Marker è¦–è¦º */
        .number-icon { background: var(--p-red); border: 2.5px solid white; border-radius: 50%; color: white; font-weight: 800; text-align: center; font-size: 14px; width: 34px !important; height: 34px !important; display: flex; align-items: center; justify-content: center; z-index: 1000 !important; }
        .number-icon.selected-for-action { background: var(--p-orange) !important; transform: scale(1.2); box-shadow: 0 0 15px var(--p-orange); }
        .number-icon.active-edit { background: var(--p-green) !important; }

        textarea { width: 100%; height: 100px; font-size: 14px; border: 1.5px solid #ced4da; border-radius: 8px; padding: 10px; }
        button.main-btn { width: 100%; padding: 18px; margin: 8px 0; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; }
        
        #dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100000; display: none; align-items: center; justify-content: center; }
        .dialog-box { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .badge { background: var(--p-blue); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-top: 5px; display: inline-block; }
    </style>
</head>
<body>

<button id="menu-btn" onclick="toggleMenu()">â˜°</button>
<div id="side-menu">
    <a href="index.html" class="menu-item">è·¯å¾‘ç”Ÿæˆå™¨</a>
    <a href="#" class="menu-item" onclick="location.reload()">è·¯å¾‘ä¿®æ”¹å™¨</a>
</div>

<div id="controls">
    <h2 style="text-align: center; color: var(--p-green); margin-top: 0;">çš®å…‹æ•è·¯å¾‘ä¿®æ”¹å™¨</h2>
    
    <div class="mode-selector">
        <div class="mode-card active" onclick="switchMode('merge')">ğŸ”— åˆä½µæ¨¡å¼</div>
        <div class="mode-card" onclick="switchMode('add')">â• è¿½åŠ æ¨¡å¼</div>
        <div class="mode-card" onclick="switchMode('split')">âœ‚ï¸ åˆ†å‰²æ¨¡å¼</div>
    </div>

    <div class="card" style="border-left-color: var(--p-dark);">
        <label style="font-weight:bold;">åœ–å½¢æ¨¡å¼è¨­å®šï¼š</label>
        <div style="display:flex; gap:15px; margin-top:10px;">
            <label><input type="radio" name="globalMode" value="linear" checked onchange="updateDetectBadge()"> æ”¶æœ</label>
            <label><input type="radio" name="globalMode" value="z-shape" id="radio-z" onchange="updateDetectBadge()"> Zå­—</label>
            <label><input type="radio" name="globalMode" value="s-shape" id="radio-s" onchange="updateDetectBadge()"> Så‹</label>
        </div>
        <div id="detect-badge-area"></div>
    </div>

    <div id="section-merge" class="card">
        <label style="font-weight:bold;">é¸æ“‡å¤šå€‹æª”æ¡ˆåˆä½µï¼š</label>
        <div id="file-upload-list" style="margin-top:10px;">
            <div style="margin-bottom:10px;"><input type="file" accept=".gpx" class="merge-file-input" onchange="autoDetectMode(this)"></div>
        </div>
        <button class="main-btn" style="background:var(--p-blue); padding:10px; font-size:14px;" onclick="addUploadField()">â• å†å¢åŠ ä¸€å€‹æª”æ¡ˆ</button>
    </div>

    <div id="section-add" class="card is-hidden" style="border-left-color: var(--p-orange);">
        <label style="font-weight:bold;">åŸå§‹æª”æ¡ˆï¼š</label>
        <input type="file" id="add-file-input" accept=".gpx" style="width:100%; margin:10px 0;" onchange="autoDetectMode(this)">
        <label style="font-weight:bold;">æ‰‹å‹•è¿½åŠ åº§æ¨™ï¼š</label>
        <textarea id="add-coord-input" placeholder="ç·¯åº¦, ç¶“åº¦ ä¸€è¡Œä¸€å€‹"></textarea>
    </div>

    <div id="section-split" class="card is-hidden" style="border-left-color: var(--p-red);">
        <label style="font-weight:bold;">ä¸Šå‚³å¾…åˆ†å‰²è·¯å¾‘ï¼š</label>
        <input type="file" id="split-file-input" accept=".gpx" style="width:100%; margin:10px 0;" onchange="autoDetectMode(this)">
    </div>

    <button class="main-btn" style="background:var(--p-green)" onclick="initApp()">è®€å–è³‡æ–™ä¸¦é€²è¡Œç·¨ä¿®</button>
</div>

<div id="map-container">
    <div id="session-sidebar" class="is-hidden"></div>

    <div class="map-btn-group">
        <button class="map-ctrl-btn" id="selection-mode-btn" style="background:var(--p-blue)" onclick="toggleSelectionMode()">ğŸ‘† é»é¸åº§æ¨™</button>
        <button class="map-ctrl-btn" id="confirm-selection-btn" style="background:var(--p-orange); display:none;" onclick="showSplitDialog()">âœ… åŸ·è¡Œè™•ç†</button>
        <button class="map-ctrl-btn" style="background:var(--p-green)" onclick="showSaveDialog()">ğŸ’¾ å„²å­˜æ­¤æ®µ</button>
        <button class="map-ctrl-btn" style="background:var(--p-red)" onclick="closeMap()">é€€å‡º</button>
    </div>
    <div id="map"></div>

    <div id="bottom-editor">
        <div id="edit-label" style="text-align:center; font-weight:bold; color:var(--p-green); font-size:12px;">é»ä½é †åºèª¿æ•´</div>
        <div class="action-row">
            <button class="btn-act" style="background:var(--p-orange); color:white" onclick="togglePickingOrder()">ğŸ”¢ è‡ªé¸é †åº</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="moveSequence(-1)">â¬† å‰ç§»</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="moveSequence(1)">â¬‡ å¾Œç§»</button>
        </div>
        <div class="action-row">
            <button class="btn-act" style="background:#f1f3f5" onclick="rotatePoint(45)">â†» æ—‹è½‰åœ–å½¢</button>
            <button class="btn-act" style="background:var(--p-red); color:white" onclick="deletePoint()">ğŸ—‘ï¸ åˆªé™¤</button>
            <button class="btn-act" style="background:var(--p-dark); color:white" onclick="closeEditor()">å®Œæˆ</button>
        </div>
    </div>
</div>

<div id="dialog-overlay">
    <div id="split-action" class="dialog-box" style="display:none;">
        <h3 id="sel-count-text">é¸ä¸­ 0 å€‹åº§æ¨™</h3>
        <button class="main-btn" style="background:var(--p-blue)" onclick="executeAction('split')">âœ‚ï¸ åˆ†å‰²ç‚ºå…©çµ„ä¸¦å€‹åˆ¥ç·¨è¼¯</button>
        <button class="main-btn" style="background:var(--p-red)" onclick="executeAction('keep-selected')">ä¿ç•™é¸ä¸­ (å…¶é¤˜åˆªé™¤)</button>
        <button class="main-btn" style="background:var(--p-dark)" onclick="executeAction('keep-unselected')">ä¿ç•™æœªé¸ (é¸ä¸­åˆªé™¤)</button>
        <button class="main-btn" style="background:#ced4da; color:#333;" onclick="cancelAction()">å–æ¶ˆ</button>
    </div>

    <div id="save-dialog" class="dialog-box" style="display:none;">
        <h3>è‡ªè¨‚å„²å­˜åç¨±</h3>
        <p style="font-size:12px; color:#666;">æª”åèˆ‡è·¯å¾‘å…§éƒ¨åç¨±å°‡æœƒåŒæ­¥</p>
        <input type="text" id="save-filename" placeholder="è¼¸å…¥åç¨± (ä¾‹å¦‚ï¼šä¸­å±±å€èŠ±ç”°)" style="width:100%; padding:15px; margin-bottom:15px; border-radius:12px; border:1.5px solid #ddd; font-size:16px;">
        <button class="main-btn" style="background:var(--p-green)" onclick="executeFinalSave()">ç¢ºèªä¸‹è¼‰ GPX</button>
        <button class="main-btn" style="background:#ced4da; color:#333;" onclick="hideSaveDialog()">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    var map, markers = [], activeMode = 'linear';
    var sessions = {}; // ç®¡ç†å¤šå€‹è·¯å¾‘åˆ†æ®µ
    var currentSessionKey = "";
    var isSelectionMode = false, selectedIdxList = [], editingIdx = -1;
    var isPickingOrder = false, pickedSequence = [];

    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
    function switchMode(m) {
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        ['merge', 'add', 'split'].forEach(s => document.getElementById(`section-${s}`).classList.add('is-hidden'));
        document.getElementById(`section-${m}`).classList.remove('is-hidden');
    }
    function addUploadField() {
        const div = document.createElement('div'); div.style.marginBottom = "10px";
        div.innerHTML = `<input type="file" accept=".gpx" class="merge-file-input" onchange="autoDetectMode(this)">`;
        document.getElementById('file-upload-list').appendChild(div);
    }
    async function autoDetectMode(input) {
        const file = input.files[0]; if(!file) return;
        const text = await file.text();
        const badgeArea = document.getElementById('detect-badge-area');
        if(text.includes("z-shape") || text.includes("Zå­—åœ–å½¢")) {
            document.getElementById('radio-z').checked = true;
            badgeArea.innerHTML = `<span class="badge">åµæ¸¬ï¼šZå­—è·¯å¾‘</span>`;
        } else if(text.includes("s-shape") || text.includes("Så‹åœ–å½¢")) {
            document.getElementById('radio-s').checked = true;
            badgeArea.innerHTML = `<span class="badge">åµæ¸¬ï¼šSå‹è·¯å¾‘</span>`;
        }
        activeMode = document.querySelector('input[name="globalMode"]:checked').value;
    }
    function updateDetectBadge() { activeMode = document.querySelector('input[name="globalMode"]:checked').value; }

    async function getPointsFromFile(file) {
        if(!file) return [];
        const text = await file.text();
        const regex = /lat=["']([\d.-]+)["']\s+lon=["']([\d.-]+)["']/g;
        let allPts = [], m;
        while((m = regex.exec(text)) !== null) allPts.push({lat: parseFloat(m[1]), lng: parseFloat(m[2]), angle: 0});
        
        // é€†å‘ä¸­å¿ƒé‚„åŸ
        let centers = [];
        if(activeMode === 'z-shape' && allPts.length >= 5) { for(let i=2; i < allPts.length; i+=5) centers.push(allPts[i]); }
        else if(activeMode === 's-shape' && allPts.length >= 7) { for(let i=3; i < allPts.length; i+=7) centers.push(allPts[i]); }
        else centers = allPts;
        return centers;
    }

    async function initApp() {
        const mode = document.querySelector('.mode-card.active').innerText.includes("åˆä½µ") ? 'merge' : (document.querySelector('.mode-card.active').innerText.includes("è¿½åŠ ") ? 'add' : 'split');
        let combinedPts = [];
        if(mode === 'merge') {
            const inputs = document.querySelectorAll('.merge-file-input');
            for(let input of inputs) combinedPts.push(...(await getPointsFromFile(input.files[0])));
        } else if(mode === 'add') {
            combinedPts.push(...(await getPointsFromFile(document.getElementById('add-file-input').files[0])));
            const str = document.getElementById('add-coord-input').value;
            const matches = str.match(/-?\d+\.\d+/g);
            if(matches) for(let i=0; i<matches.length; i+=2) combinedPts.push({lat: parseFloat(matches[i]), lng: parseFloat(matches[i+1]), angle: 0});
        } else {
            combinedPts.push(...(await getPointsFromFile(document.getElementById('split-file-input').files[0])));
        }

        if(combinedPts.length === 0) return alert("è«‹ä¸Šå‚³æª”æ¡ˆæˆ–è²¼ä¸Šåº§æ¨™");
        
        // å»é‡
        const seen = new Set();
        const finalPts = combinedPts.filter(p => {
            const k = `${p.lat.toFixed(6)},${p.lng.toFixed(6)}`;
            return seen.has(k) ? false : seen.add(k);
        });

        sessions = { "ä¸»è·¯å¾‘": finalPts };
        currentSessionKey = "ä¸»è·¯å¾‘";
        openMap(); refreshPaths(); updateSessionSidebar();
    }

    function openMap() {
        document.getElementById('map-container').style.display = 'block';
        if (!map) {
            map = L.map('map', {zoomControl: false});
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.control.zoom({position: 'bottomright'}).addTo(map);
        }
    }

    function updateSessionSidebar() {
        const sidebar = document.getElementById('session-sidebar');
        const keys = Object.keys(sessions);
        if(keys.length <= 1) { sidebar.classList.add('is-hidden'); return; }
        
        sidebar.classList.remove('is-hidden');
        sidebar.innerHTML = "<div style='font-size:10px; font-weight:bold; color:#666; margin-bottom:5px;'>é¸æ“‡ç·¨è¼¯è·¯å¾‘ï¼š</div>";
        keys.forEach(key => {
            const btn = document.createElement('div');
            btn.className = "session-btn" + (key === currentSessionKey ? " active" : "");
            btn.innerText = key + ` (${sessions[key].length}é»)`;
            btn.onclick = () => { currentSessionKey = key; updateSessionSidebar(); refreshPaths(); closeEditor(); };
            sidebar.appendChild(btn);
        });
    }

    function toggleSelectionMode() {
        isSelectionMode = !isSelectionMode;
        selectedIdxList = [];
        const btn = document.getElementById('selection-mode-btn');
        const confirmBtn = document.getElementById('confirm-selection-btn');
        if(isSelectionMode) { btn.innerText = "â¹ åœæ­¢é»é¸"; btn.style.background = "var(--p-orange)"; confirmBtn.style.display = "block"; }
        else { btn.innerText = "ğŸ‘† é»é¸åº§æ¨™"; btn.style.background = "var(--p-blue)"; confirmBtn.style.display = "none"; }
        refreshPaths();
    }

    function refreshPaths() {
        const data = sessions[currentSessionKey] || [];
        map.eachLayer(l => { if(l instanceof L.Marker || l instanceof L.Polyline || l instanceof L.Circle) map.removeLayer(l); });
        markers = []; const fullTrack = [];

        data.forEach((curr, i) => {
            const group = buildGroup(curr, activeMode);
            fullTrack.push(...group);
            
            // 30ç±³çµ±ä¸€åŠå¾‘æ¡†
            L.circle([curr.lat, curr.lng], {
                radius: 30, color: 'white', weight: 1.5,
                fillColor: (isSelectionMode && selectedIdxList.includes(i)) ? 'var(--p-orange)' : (editingIdx === i ? 'var(--p-green)' : 'var(--p-blue)'),
                fillOpacity: 0.15, dashArray: '5, 5'
            }).addTo(map);

            const m = L.marker([curr.lat, curr.lng], { 
                icon: L.divIcon({ 
                    className: 'number-icon' + (isSelectionMode && selectedIdxList.includes(i) ? ' selected-for-action' : '') + (editingIdx === i ? ' active-edit' : ''), 
                    html: isPickingOrder ? (pickedSequence.indexOf(i)+1||'?') : i+1, iconSize:[34,34] 
                })
            }).addTo(map);
            m.on('click', () => handleMarkerClick(i));
            markers[i] = m;
            L.polyline(group.map(p => [p[1], p[0]]), { color: editingIdx===i?'#2f9e44':'#1971c2', weight: 4 }).addTo(map);
        });

        if(fullTrack.length > 1) {
            fullTrack.push(fullTrack[0]);
            L.polyline(fullTrack.map(p => [p[1], p[0]]), { color: '#1971c2', weight: 3, opacity: 0.8 }).addTo(map);
            if(!isSelectionMode && markers.length > 0) map.fitBounds(L.featureGroup(markers.filter(m=>m)).getBounds(), {padding:[50,50]});
        }
    }

    function buildGroup(curr, mode) {
        const cp = turf.point([curr.lng, curr.lat]);
        if (mode === 'z-shape') {
            const r = 41;
            const v = { tl: turf.destination(cp, r, curr.angle-45, {units:'meters'}).geometry.coordinates, tr: turf.destination(cp, r, curr.angle+45, {units:'meters'}).geometry.coordinates, bl: turf.destination(cp, r, curr.angle-135, {units:'meters'}).geometry.coordinates, br: turf.destination(cp, r, curr.angle+135, {units:'meters'}).geometry.coordinates };
            return [v.tl, v.tr, [curr.lng, curr.lat], v.bl, v.br];
        } 
        if (mode === 's-shape') {
            const r = 30;
            const v = { tr: turf.destination(cp, r, curr.angle+45, {units:'meters'}).geometry.coordinates, tl: turf.destination(cp, r, curr.angle-45, {units:'meters'}).geometry.coordinates, ml: turf.destination(cp, r, curr.angle-90, {units:'meters'}).geometry.coordinates, mr: turf.destination(cp, r, curr.angle+90, {units:'meters'}).geometry.coordinates, br: turf.destination(cp, r, curr.angle+135, {units:'meters'}).geometry.coordinates, bl: turf.destination(cp, r, curr.angle-135, {units:'meters'}).geometry.coordinates };
            return [v.tr, v.tl, v.ml, [curr.lng, curr.lat], v.mr, v.br, v.bl];
        }
        return [[curr.lng, curr.lat]];
    }

    function handleMarkerClick(idx) {
        if(isSelectionMode) {
            const pos = selectedIdxList.indexOf(idx); if(pos > -1) selectedIdxList.splice(pos, 1); else selectedIdxList.push(idx);
            refreshPaths(); return;
        }
        if(isPickingOrder) {
            const pIdx = pickedSequence.indexOf(idx); if(pIdx > -1) pickedSequence.splice(pIdx, 1); else pickedSequence.push(idx);
            if(pickedSequence.length === sessions[currentSessionKey].length) { sessions[currentSessionKey] = pickedSequence.map(i => sessions[currentSessionKey][i]); pickedSequence = []; isPickingOrder = false; }
            refreshPaths(); return;
        }
        editingIdx = idx; document.getElementById('bottom-editor').style.display = 'block'; refreshPaths();
    }

    function executeAction(type) {
        const data = sessions[currentSessionKey];
        const sData = data.filter((_, i) => selectedIdxList.includes(i));
        const uData = data.filter((_, i) => !selectedIdxList.includes(i));

        if(type === 'split') {
            const timeTag = new Date().toLocaleTimeString();
            sessions["åˆ†æ®µ A"] = sData;
            sessions["åˆ†æ®µ B"] = uData;
            delete sessions[currentSessionKey];
            currentSessionKey = "åˆ†æ®µ A";
        } else if(type === 'keep-selected') {
            sessions[currentSessionKey] = sData;
        } else if(type === 'keep-unselected') {
            sessions[currentSessionKey] = uData;
        }
        toggleSelectionMode(); cancelAction(); refreshPaths(); updateSessionSidebar();
    }

    function showSaveDialog() {
        document.getElementById('dialog-overlay').style.display = 'flex';
        document.getElementById('save-dialog').style.display = 'block';
        document.getElementById('split-action').style.display = 'none';
        document.getElementById('save-filename').value = currentSessionKey === "ä¸»è·¯å¾‘" ? "" : currentSessionKey;
    }

    function executeFinalSave() {
        const data = sessions[currentSessionKey];
        const name = document.getElementById('save-filename').value || "Pikmin_Route";
        if(!data || data.length === 0) return;
        
        let pts = []; data.forEach(c => pts.push(...buildGroup(c, activeMode)));
        if(pts.length) pts.push(pts[0]);
        
        // æª”åèˆ‡è·¯å¾‘å…§éƒ¨åç¨±ä¸€è‡´
        let gpx = `<?xml version="1.1"?><gpx version="1.1"><trk><name>${name}</name><trkseg>` + pts.map(p => `\n<trkpt lat="${p[1].toFixed(8)}" lon="${p[0].toFixed(8)}"></trkpt>`).join('') + `\n</trkseg></trk></gpx>`;
        
        const blob = new Blob([gpx], { type: 'application/gpx+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${name}.gpx`; a.click();
        hideSaveDialog();
    }

    function showSplitDialog() { document.getElementById('sel-count-text').innerText = `å·²é¸ä¸­ ${selectedIdxList.length} å€‹åº§æ¨™`; document.getElementById('dialog-overlay').style.display = 'flex'; document.getElementById('split-action').style.display = 'block'; }
    function cancelAction() { document.getElementById('dialog-overlay').style.display = 'none'; }
    function hideSaveDialog() { document.getElementById('dialog-overlay').style.display = 'none'; }
    function closeMap() { if(confirm("ç¢ºå®šè¦é€€å‡ºä¸¦æ¸…é™¤ç›®å‰ç·¨ä¿®å—ï¼Ÿ")) document.getElementById('map-container').style.display = 'none'; }
    function deletePoint() { if(editingIdx >= 0) { sessions[currentSessionKey].splice(editingIdx, 1); editingIdx = -1; refreshPaths(); updateSessionSidebar(); } }
    function moveSequence(dir) { const data = sessions[currentSessionKey]; if(editingIdx < 0) return; const target = editingIdx + dir; if(target >= 0 && target < data.length) { [data[editingIdx], data[target]] = [data[target], data[editingIdx]]; editingIdx = target; refreshPaths(); } }
    function rotatePoint(v) { if(editingIdx >= 0) { sessions[currentSessionKey][editingIdx].angle = (sessions[currentSessionKey][editingIdx].angle + v) % 360; refreshPaths(); } }
    function closeEditor() { document.getElementById('bottom-editor').style.display = 'none'; editingIdx = -1; refreshPaths(); }
    function togglePickingOrder() { isPickingOrder = !isPickingOrder; pickedSequence = []; refreshPaths(); }
</script>
</body>
</html>
