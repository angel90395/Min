<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>GPX 高階 TSP & Z型軌跡生成器 (支援多格式上傳)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #f4f4f4; }
        #sidebar { width: 400px; padding: 20px; background: white; border-right: 1px solid #ddd; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; }
        #map { flex: 1; }
        .card { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-left: 5px solid #007bff; }
        h2 { margin-top: 0; color: #333; font-size: 1.2rem; }
        textarea { width: 100%; height: 120px; margin-top: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; resize: vertical; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .btn-gen { background: #007bff; color: white; }
        .btn-gen:hover { background: #0056b3; }
        .btn-download { background: #28a745; color: white; display: none; }
        .info { font-size: 0.8rem; color: #666; line-height: 1.4; }
        .debug-info { color: #d9534f; font-weight: bold; font-size: 0.8rem; margin-top: 5px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>GPX 軌跡優化 (繁中修正版)</h2>
    <p class="info">
        1. 直接貼上座標，格式：<code>緯度, 經度</code><br>
        2. 或上傳 GPX/TXT 檔案 (支援 wpt, trkpt, rtept)<br>
        3. 每組中心點會生成直徑 82m 的 Z 字型路徑。
    </p>
    
    <div class="card">
        <strong>1. 輸入座標點 (每行一個):</strong>
        <textarea id="coordInput" placeholder="40.9787100, 39.8320820&#10;40.9790000, 39.8330000"></textarea>
    </div>

    <div class="card" style="border-left-color: #ffc107;">
        <strong>2. 或上傳檔案 (GPX):</strong>
        <input type="file" id="gpxFile" accept=".gpx,.xml" style="width: 100%; margin-top: 10px;">
    </div>
    
    <button class="btn-gen" onclick="processData()">執行優化與地圖預覽</button>
    <button id="downloadBtn" class="btn-download" onclick="downloadGPX()">下載生成的 GPX</button>
    
    <div id="status"
