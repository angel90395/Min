<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>çš®å…‹æ•è·¯å¾‘ç”Ÿæˆå™¨ - é€²éšç·¨è¼¯ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f0f4f8; overflow-x: hidden; }
        body { display: flex; flex-direction: column; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; }

        #controls { width: 100%; min-height: 100vh; padding: 15px; background: white; z-index: 100; overflow-y: auto; }
        .is-hidden { display: none !important; }

        /* å…¬å‘Šèˆ‡èªªæ˜ */
        #bulletin-section { background: #fff9db; border: 1px solid #fab005; border-radius: 12px; padding: 20px; margin-bottom: 15px; font-size: 0.95rem; color: #444; line-height: 1.7; }
        #bulletin-section h4 { margin: 15px 0 8px 0; color: #d9480f; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }
        .instruction-card { background: #e7f5ff; border: 1px solid #a5d8ff; border-radius: 10px; padding: 15px; margin-bottom: 15px; font-size: 0.9rem; color: #1864ab; }
        #generator-section { display: none; }

        /* æ¨¡å¼è¤‡é¸ */
        .mode-option { display: flex; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #dee2e6; cursor: pointer; }
        .mode-option input { margin-right: 12px; width: 22px; height: 22px; }

        /* æµ®è²¼åœ°åœ– */
        #map-container { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 320px; z-index: 99999; display: none; box-shadow: 0 4px 25px rgba(0,0,0,0.4); border-radius: 15px; border: 3px solid #fff; overflow: hidden; transition: 0.4s ease; }
        #map-container.is-fullscreen { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; border: none; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* åœ°åœ–æ§åˆ¶éˆ• (ä¸‹ç§»é¿é–‹ç³»çµ±åˆ—) */
        .map-btn-group { position: absolute; top: 80px; right: 15px; z-index: 100000; display: flex; flex-direction: column; gap: 10px; }
        .map-ctrl-btn { background: rgba(33, 37, 41, 0.9); color: white; border: none; padding: 10px 14px; border-radius: 8px; font-weight: bold; font-size: 13px; cursor: pointer; }
        .btn-save-dl { background: #2f9e44 !important; }
        .btn-close-map { background: #e03131 !important; }

        /* å´é‚Šé è¦½é¸å–® */
        #map-sidebar { position: absolute; top: 80px; left: 10px; z-index: 100000; background: rgba(255,255,255,0.9); border-radius: 8px; padding: 8px; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 130px; }
        .sidebar-btn { background: #fff; border: 1px solid #ddd; padding: 6px; border-radius: 4px; font-size: 11px; cursor: pointer; text-align: left; }
        .sidebar-btn.active { background: #2f9e44; color: white; border-color: #2f9e44; }

        /* å½ˆçª—å…§æ‹‰æ¡¿ */
        .popup-ctrl { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .popup-ctrl label { font-size: 12px; font-weight: bold; }
        .btn-pop-del { background: #e03131; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; margin-top: 8px; cursor: pointer; width: 100%; }
        .btn-pop-flip { background: #1971c2; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; margin-top: 5px; cursor: pointer; width: 100%; }

        .card { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6; border-left: 6px solid #2f9e44; }
        .card-y { border-left-color: #fcc419; }
        textarea { width: 100%; height: 80px; font-size: 14px; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; font-family: monospace; }
        
        button { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-agree { background: #2f9e44; color: white; }
        .btn-gen { background: #2f9e44; color: white; }
        .btn-direct-dl { background: #1971c2; color: white; }
        .btn-clear { background: #f08c00; color: white; } 
        
        #status { font-size: 13px; color: #fa5252; text-align: center; margin-top: 8px; font-weight: bold; }

        @media (min-width: 768px) { #controls { width: 450px; } #map-container { width: 480px; height: 480px; } .map-btn-group { top: 20px; flex-direction: row; } #map-sidebar { top: 20px; } }
    </style>
</head>
<body id="mainBody">

<div id="controls">
    <h2 style="margin: 0 0 20px; text-align: center; color: #2f9e44;">çš®å…‹æ•æ”¶æœç¨®èŠ±è·¯å¾‘ç”Ÿæˆå™¨</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>é€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•é£›äººæ”¶æœã€ç¨®èŠ±çš„GPXç”Ÿæˆå™¨ï¼Œä½†è«‹ä¸è¦ç”¨ä¾†ç”¢ç”Ÿåˆ¥äººçš„èŠ±ç”°è·¯å¾‘ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„çš®å…‹æ•é£›äººã€‚</p>
        <h4>âš ï¸ è«‹éµå®ˆä»¥ä¸‹å¹¾é»ï¼š</h4>
        <ul>
            <li>1.æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸å ç‚ºå·±ç”¨</li>
            <li>2.æœ‰é–‹èŠ±æˆ–å›ºå®šç¨®èŠ±ä¸»çš„ç”° åƒ…ç”Ÿæˆæ”¶æœè·¯ç·š</li>
            <li>3.ç”¢ç”Ÿçš„æª”æ¡ˆè«‹è‡ªç”¨ï¼Œä¸è¦åˆ†äº«ã€‚</li>
        </ul>
        <button class="btn-agree" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="generator-section">
        <button class="btn-agree" style="background:#f8f9fa; color:#495057; border:1px solid #ddd; margin-bottom:10px;" onclick="showNotice()">æŸ¥çœ‹å…¬å‘Šèªªæ˜</button>

        <div class="instruction-card">
            <h4>ğŸ“¢ é€²éšç·¨è¼¯èªªæ˜</h4>
            <ul>
                <li>1. <b>ç§»é™¤é»ä½ï¼š</b>é»æ“Šç´…é»ï¼Œå¯é¸æ“‡ã€Œåˆªé™¤ã€æ•´çµ„åœ–å½¢ã€‚</li>
                <li>2. <b>èª¿æ•´æ—‹è½‰ï¼š</b>é»æ“Šç´…é»ï¼Œé€éæ‹‰æ¡¿èª¿æ•´è©²æ–¹å½¢/Zå­—çš„è§’åº¦ã€‚</li>
                <li>3. <b>éŠœæ¥æ–¹å‘ï¼š</b>é»æ“Šç´…é»é¸ã€Œåè½‰ã€ï¼Œæ”¹è®Šèˆ‡å‰å¾Œé»çš„é€£ç·šè·¯å¾‘ã€‚</li>
                <li>4. <b>é è¦½åˆ‡æ›ï¼š</b>å·¦å´é¸å–®å¯åˆ‡æ›ä¸åŒæ¨¡å¼çš„é è¦½è»Œè·¡ã€‚</li>
            </ul>
        </div>
        
        <div class="card">
            <label>1. é¸æ“‡ç”Ÿæˆæ¨¡å¼ (å¯è¤‡é¸)</label>
            <div id="mode-selection">
                <label class="mode-option"><input type="checkbox" name="pathMode" value="linear" checked> åº§æ¨™ä¸²æ¥ (æ”¶æœ/å¤šå¸³ç¨®èŠ±)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="z-shape"> Zå­—åœ–å½¢ (2åœˆ&é©åˆç¨®è—)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="square"> æ­£æ–¹å½¢è·¯ç·š (2åœˆ&é©åˆç¨®ç™½)</label>
            </div>
        </div>

        <div class="card card-y">
            <label>æä¾›åº§æ¨™</label>
            <select id="sourceType" onchange="toggleSource()" style="width:100%; padding:10px; border-radius:5px;">
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>

        <div id="manualSection" class="card">
            <label>åº§æ¨™è²¼å…¥è™• (ç·¯åº¦, ç¶“åº¦):</label>
            <textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦ (æ¯è¡Œä¸€çµ„)"></textarea>
            <button class="btn-clear" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <div id="fileSection" class="card card-y is-hidden">
            <label>é¸å– GPX æª”æ¡ˆ:</label>
            <input type="file" id="gpxFile" accept=".gpx,.xml" style="width: 100%;">
            <button class="btn-clear" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <button class="btn-gen" onclick="processAll(true)">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
        <button class="btn-direct-dl" onclick="processAll(false)">ç›´æ¥ç”Ÿæˆ ä¸‹è¼‰GPX</button>
        
        <div id="status"></div>
    </div>
</div>

<div id="map-container">
    <div id="map-sidebar" class="is-hidden">
        <div id="sidebar-btns"></div>
    </div>
    <div class="map-btn-group">
        <button class="map-ctrl-btn" onclick="toggleMapFullScreen()">å…¨é »/ç¸®å°</button>
        <button class="map-ctrl-btn btn-save-dl" onclick="downloadAllActive()">å„²å­˜ç·¨è¼¯ä¸¦ä¸‹è¼‰</button>
        <button class="map-ctrl-btn btn-close-map" onclick="closeMap()">é—œé–‰é è¦½</button>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    var map;
    var currentData = []; // å„²å­˜ä¸­å¿ƒé»èˆ‡å…¶è§’åº¦è¨­å®š
    var activeModeLayers = {};
    var modePathData = {};
    var markers = [];

    function acceptNotice() { document.getElementById('bulletin-section').classList.add('is-hidden'); document.getElementById('generator-section').style.display = 'block'; }
    function showNotice() { document.getElementById('bulletin-section').classList.remove('is-hidden'); document.getElementById('generator-section').style.display = 'none'; }
    function toggleSource() { const type = document.getElementById('sourceType').value; document.getElementById('manualSection').classList.toggle('is-hidden', type !== 'manual'); document.getElementById('fileSection').classList.toggle('is-hidden', type === 'manual'); }
    function clearData() { document.getElementById('coordInput').value = ""; document.getElementById('gpxFile').value = ""; document.getElementById('status').innerText = "è³‡æ–™å·²æ¸…é™¤"; }

    function openMap() {
        document.getElementById('map-container').style.display = 'block';
        if (!map) {
            map = L.map('map', { zoomControl: false }).setView([23.5, 121], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        }
        setTimeout(() => map.invalidateSize(), 400);
    }
    function closeMap() { document.getElementById('map-container').style.display = 'none'; document.getElementById('map-container').classList.remove('is-fullscreen'); }
    function toggleMapFullScreen() { document.getElementById('map-container').classList.toggle('is-fullscreen'); setTimeout(() => map.invalidateSize(), 400); }

    // --- æ ¸å¿ƒå…¥å£ ---
    async function processAll(withPreview) {
        const status = document.getElementById('status');
        const sourceType = document.getElementById('sourceType').value;
        const checkedModes = Array.from(document.querySelectorAll('input[name="pathMode"]:checked')).map(el => el.value);

        if (checkedModes.length === 0) return alert("è«‹å‹¾é¸è‡³å°‘ä¸€ç¨®æ¨¡å¼");
        status.innerText = "é‹ç®—ç”Ÿæˆä¸­...";

        try {
            let centers = [];
            if (sourceType === 'manual') {
                const txt = document.getElementById('coordInput').value.trim();
                if (!txt) throw new Error("è«‹å…ˆè²¼å…¥åº§æ¨™è³‡æ–™");
                txt.split('\n').forEach(l => {
                    const p = l.match(/-?\d+\.\d+/g);
                    if (p && p.length >= 2) centers.push({ lng: parseFloat(p[1]), lat: parseFloat(p[0]), angle: null, flipped: false });
                });
                centers = solveSmoothLoop(centers);
            } else {
                const fileInput = document.getElementById('gpxFile');
                if (fileInput.files.length === 0) throw new Error("è«‹é¸å–æª”æ¡ˆ");
                const xml = await fileInput.files[0].text();
                const regex = /lat=["']([\d.-]+)["']\s+lon=["']([\d.-]+)["']/g;
                let m; while ((m = regex.exec(xml)) !== null) centers.push({ lng: parseFloat(m[2]), lat: parseFloat(m[1]), angle: null, flipped: false });
            }

            if (centers.length === 0) throw new Error("è§£æå¤±æ•—");
            currentData = centers.filter((v, i, a) => a.findIndex(t => t.lng === v.lng && t.lat === v.lat) === i);

            if (!withPreview) {
                checkedModes.forEach(mode => { const path = buildFinalPath(currentData, mode); exportGPX(path, getModeLabel(mode)); });
                status.innerText = "ç›´æ¥ä¸‹è¼‰å®Œæˆã€‚";
            } else {
                openMap();
                renderEditor(checkedModes);
                status.innerText = "ç·¨è¼¯æ¨¡å¼å·²é–‹å•Ÿï¼Œé»æ“Šç´…é»é€²è¡Œèª¿æ•´ã€‚";
            }
        } catch (e) { status.innerText = "éŒ¯èª¤: " + e.message; }
    }

    // --- ç·¨è¼¯å™¨æ¸²æŸ“ ---
    function renderEditor(checkedModes) {
        markers.forEach(m => map.removeLayer(m)); markers = [];
        Object.values(activeModeLayers).forEach(l => map.removeLayer(l));
        activeModeLayers = {}; modePathData = {};

        const sidebar = document.getElementById('sidebar-btns');
        sidebar.innerHTML = ""; document.getElementById('map-sidebar').classList.remove('is-hidden');

        currentData.forEach((item, idx) => {
            const m = L.circleMarker([item.lat, item.lng], {radius: 7, color: '#fa5252', fillOpacity: 1});
            
            m.on('click', () => {
                const popupContent = document.createElement('div');
                popupContent.innerHTML = `<b>é»ä½ ${idx+1}</b><br><small>${item.lat.toFixed(6)}, ${item.lng.toFixed(6)}</small>`;
                
                const ctrl = document.createElement('div');
                ctrl.className = "popup-ctrl";
                ctrl.innerHTML = `<label>æ—‹è½‰æ–¹å‘: <span id="val-${idx}">${item.angle || 0}</span>Â°</label><br>
                                  <input type="range" min="0" max="360" value="${item.angle || 0}" style="width:100%" id="range-${idx}">`;
                
                const flipBtn = document.createElement('button');
                flipBtn.className = "btn-pop-flip";
                flipBtn.innerText = item.flipped ? "éŠœæ¥ï¼šåè½‰ä¸­" : "éŠœæ¥ï¼šé †å‘ä¸­";
                flipBtn.onclick = () => { item.flipped = !item.flipped; flipBtn.innerText = item.flipped ? "éŠœæ¥ï¼šåè½‰ä¸­" : "éŠœæ¥ï¼šé †å‘ä¸­"; refreshAllPaths(checkedModes); };

                const delBtn = document.createElement('button');
                delBtn.className = "btn-pop-del";
                delBtn.innerText = "ğŸ—‘ï¸ åˆªé™¤æ­¤çµ„åº§æ¨™";
                delBtn.onclick = () => { currentData.splice(idx, 1); map.closePopup(); renderEditor(checkedModes); };

                popupContent.appendChild(ctrl);
                popupContent.appendChild(flipBtn);
                popupContent.appendChild(delBtn);
                m.bindPopup(popupContent).openPopup();

                document.getElementById(`range-${idx}`).oninput = (e) => {
                    item.angle = parseInt(e.target.value);
                    document.getElementById(`val-${idx}`).innerText = item.angle;
                    refreshAllPaths(checkedModes);
                };
            });
            m.addTo(map);
            markers.push(m);
        });

        checkedModes.forEach((mode, i) => {
            const path = buildFinalPath(currentData, mode);
            modePathData[mode] = path;
            const layer = L.polyline(path.map(p => [p[1], p[0]]), {color: '#1971c2', weight: 4, opacity: 0.8});
            activeModeLayers[mode] = layer;

            const sBtn = document.createElement('button');
            sBtn.className = "sidebar-btn" + (i === 0 ? " active" : "");
            sBtn.innerText = getModeLabel(mode);
            sBtn.onclick = () => {
                Object.values(activeModeLayers).forEach(l => map.removeLayer(l));
                layer.addTo(map);
                document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
                sBtn.classList.add('active');
            };
            sidebar.appendChild(sBtn);
            if (i === 0) layer.addTo(map);
        });

        const group = new L.featureGroup([...Object.values(activeModeLayers), ...markers]);
        map.fitBounds(group.getBounds(), {padding: [40, 40]});
    }

    function refreshAllPaths(checkedModes) {
        checkedModes.forEach(mode => {
            const path = buildFinalPath(currentData, mode);
            modePathData[mode] = path;
            activeModeLayers[mode].setLatLngs(path.map(p => [p[1], p[0]]));
        });
    }

    function downloadAllActive() {
        Object.keys(modePathData).forEach(mode => exportGPX(modePathData[mode], getModeLabel(mode)));
        alert("å·²å„²å­˜ç·¨è¼¯ä¸¦ä¸‹è¼‰æª”æ¡ˆï¼");
    }

    function getModeLabel(v) { if (v === 'linear') return "åº§æ¨™ä¸²æ¥"; if (v === 'z-shape') return "Zå­—åœ–å½¢"; return "æ­£æ–¹å½¢è·¯ç·š"; }

    function solveSmoothLoop(pts) {
        if (pts.length < 3) return pts;
        let route = [...pts];
        const center = turf.center(turf.featureCollection(route.map(p => turf.point([p.lng, p.lat])))).geometry.coordinates;
        route.sort((a, b) => Math.atan2(a.lat-center[1], a.lng-center[0]) - Math.atan2(b.lat-center[1], b.lng-center[0]));
        return route;
    }

    function buildFinalPath(data, mode) {
        let path = []; const r = 41;
        for (let i = 0; i < data.length; i++) {
            const curr = data[i];
            if (mode === 'linear') { path.push([curr.lng, curr.lat]); continue; }
            
            let bearing;
            if (curr.angle !== null) {
                bearing = curr.angle;
            } else {
                const prev = data[i === 0 ? data.length - 1 : i - 1];
                const next = data[(i + 1) % data.length];
                bearing = turf.bearing(turf.point([prev.lng, prev.lat]), turf.point([next.lng, next.lat]));
            }

            const cp = turf.point([curr.lng, curr.lat]);
            const v = {
                a: turf.destination(cp, r, bearing - 135, {units:'meters'}).geometry.coordinates,
                b: turf.destination(cp, r, bearing - 45, {units:'meters'}).geometry.coordinates,
                c: turf.destination(cp, r, bearing + 45, {units:'meters'}).geometry.coordinates,
                d: turf.destination(cp, r, bearing + 135, {units:'meters'}).geometry.coordinates
            };
            
            let group = (mode === 'z-shape') ? [v.a, v.b, [curr.lng, curr.lat], v.d, v.c] : [v.a, v.b, v.c, v.d, v.a];
            
            if (curr.flipped) group.reverse(); // æ‰‹å‹•åè½‰éŠœæ¥æ–¹å‘

            path.push(...group);
        }
        if (path.length > 0) {
            path = path.filter((v, i, a) => i === 0 || turf.distance(turf.point(v), turf.point(a[i-1])) > 0.00001);
            path.push(path[0]);
        }
        return path;
    }

    function exportGPX(pts, name) {
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="PikminEdit"><trk><name>${name}</name><trkseg>`;
        pts.forEach(pt => gpx += `\n<trkpt lat="${pt[1].toFixed(8)}" lon="${pt[0].toFixed(8)}"></trkpt>`);
        gpx += `\n</trkseg></trk></gpx>`;
        const blob = new Blob([gpx], { type: 'application/gpx+xml' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `pikmin_${name}_${Date.now()}.gpx`; a.click();
    }
</script>
</body>
</html>
