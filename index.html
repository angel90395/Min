<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>çš®å…‹æ•ç¨®èŠ±æ”¶æœè·¯å¾‘ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f0f4f8; overflow-x: hidden; }
        body { display: flex; flex-direction: column; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; }

        #controls { width: 100%; min-height: 100vh; padding: 15px; background: white; z-index: 100; overflow-y: auto; }
        .is-hidden { display: none !important; }

        /* å…¬å‘Šèˆ‡èªªæ˜ */
        #bulletin-section { background: #fff9db; border: 1px solid #fab005; border-radius: 12px; padding: 20px; margin-bottom: 15px; font-size: 0.95rem; color: #444; line-height: 1.7; }
        #bulletin-section h4 { margin: 15px 0 8px 0; color: #d9480f; font-size: 1.1rem; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }
        #generator-section { display: none; }
        .instruction-card { background: #e7f5ff; border: 1px solid #a5d8ff; border-radius: 10px; padding: 15px; margin-bottom: 15px; font-size: 0.9rem; color: #1864ab; }

        /* æ¨¡å¼è¤‡é¸æ¨£å¼ */
        .mode-option { display: flex; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #dee2e6; cursor: pointer; font-size: 0.95rem; }
        .mode-option input { margin-right: 12px; width: 22px; height: 22px; }

        /* æµ®è²¼åœ°åœ– */
        #map-container { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 320px; z-index: 999; display: none; box-shadow: 0 4px 25px rgba(0,0,0,0.4); border-radius: 15px; border: 3px solid #fff; overflow: hidden; transition: 0.4s ease; }
        #map-container.is-fullscreen { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; border: none; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* åœ°åœ–æ§åˆ¶éˆ•ä¸‹ç§» */
        .map-btn-group { position: absolute; top: 100px; right: 15px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .map-ctrl-btn { background: rgba(33, 37, 41, 0.9); color: white; border: none; padding: 12px 16px; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

        /* åº•éƒ¨æ§åˆ¶æ¢ (ç›´è¦ºå¼æ“ä½œ) */
        #bottom-editor {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; z-index: 10000; border-top: 4px solid #2f9e44;
            padding: 15px; display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        }
        .action-row { display: flex; gap: 8px; justify-content: center; }
        .btn-act { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; }

        /* æ¨¡å¼åˆ‡æ›é¸å–® */
        #map-sidebar { position: absolute; top: 100px; left: 10px; z-index: 2000; background: rgba(255,255,255,0.95); border-radius: 8px; padding: 8px; display: flex; flex-direction: column; gap: 5px; width: 130px; }
        .sidebar-btn { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 5px; font-size: 11px; text-align: left; }
        .sidebar-btn.active { background: #2f9e44; color: white; }

        /* å¡ç‰‡èˆ‡æŒ‰éˆ• */
        .card { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6; border-left: 6px solid #2f9e44; }
        textarea { width: 100%; height: 80px; font-size: 14px; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; }
        button { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-gen { background: #2f9e44; color: white; }
        .btn-clear { background: #f08c00; color: white; }
        #status { font-size: 13px; color: #fa5252; text-align: center; margin-top: 8px; font-weight: bold; }

        @media (min-width: 768px) { #controls { width: 450px; } #map-container { width: 550px; height: 550px; } }
    </style>
</head>
<body id="mainBody">

<div id="controls">
    <h2 style="margin: 0 0 20px; text-align: center; color: #2f9e44;">çš®å…‹æ•ç¨®èŠ±æ”¶æœè·¯å¾‘ç”Ÿæˆå™¨</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>é€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•æ”¶æœã€ç¨®èŠ±çš„GPXç”Ÿæˆå™¨ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„é£›äººã€‚</p>
        <h4>âš ï¸ è‡ªå¾‹å®ˆå‰‡</h4>
        <ul>
            <li>1.æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸å ç‚ºå·±ç”¨</li>
            <li>2.æª”æ¡ˆè«‹è‡ªç”¨ï¼Œä¸åˆ†äº«ã€‚</li>
        </ul>
        <button style="background:#2f9e44; color:white" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="generator-section">
        <div class="instruction-card">
            <h4>ğŸ“¢ ä½¿ç”¨èªªæ˜</h4>
            <ul>
                <li>1. <b>ç›´è¦ºç·¨è¼¯ï¼š</b>é»æ“Šåœ°åœ–ä¸Šçš„<b>ä»»ä½•ç·šæ¢</b>æˆ–<b>ç´…é»</b>å³å¯é–‹å•Ÿç·¨è¼¯ã€‚</li>
                <li>2. <b>åˆ‡æ›èµ·é»ï¼š</b>é‡å° Z å­—èˆ‡æ–¹å½¢ï¼Œé»æ“Šã€Œåˆ‡æ›éŠœæ¥ã€å¯æ”¹è®Šé€²å‡ºå£ä½ç½®ã€‚</li>
                <li>3. <b>æ¼æ–—æ¨¡å¼ï¼š</b>éµå¾ªåœ“å¿ƒâ†’TLâ†’TRâ†’åœ“å¿ƒâ†’BLâ†’BRâ†’åœ“å¿ƒé‚è¼¯ã€‚</li>
                <li>4. <b>æ‰‹å‹•æ¸…ç©ºï¼š</b>è³‡æ–™ä¸æœƒè‡ªå‹•æ¶ˆå¤±ï¼Œè«‹é»æ©˜è‰²æŒ‰éˆ•æ¸…ç©ºã€‚</li>
            </ul>
        </div>
        
        <div class="card">
            <label>1. é¸æ“‡ç”Ÿæˆæ¨¡å¼ (å¯è¤‡é¸)</label>
            <div>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="linear"> åº§æ¨™ä¸²æ¥ (æ”¶æœ/å¤šå¸³ç¨®èŠ±)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="z-shape" checked> Zå­—åœ–å½¢ (2åœˆ&é©åˆç¨®è—)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="square"> æ­£æ–¹å½¢è·¯ç·š (2åœˆ&é©åˆç¨®ç™½)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="funnel"> æ¼æ–—å‹è·¯ç·š (å¯†é›†ç¨®èŠ±æ¨¡å¼)</label>
            </div>
        </div>

        <div class="card" style="border-left-color: #fcc419;">
            <label>æä¾›åº§æ¨™</label>
            <select id="sourceType" onchange="toggleSource()" style="width:100%; padding:10px;">
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>

        <div id="manualSection" class="card">
            <textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦ (æ¯è¡Œä¸€çµ„)"></textarea>
            <button class="btn-clear" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <div id="fileSection" class="card is-hidden" style="border-left-color: #fcc419;">
            <input type="file" id="gpxFile" accept=".gpx,.xml" style="width: 100%;">
            <button class="btn-clear" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <button class="btn-gen" onclick="processAll(true)">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
        <button style="background:#1971c2; color:white;" onclick="processAll(false)">ç›´æ¥ç”Ÿæˆ ä¸‹è¼‰GPX</button>
        <button style="background:#f8f9fa; color:#495057; border:1px solid #ddd;" onclick="showNotice()">æŸ¥çœ‹å…¬å‘Šå®ˆå‰‡</button>
        <div id="status"></div>
    </div>
</div>

<div id="map-container">
    <div id="map-sidebar" class="is-hidden"><div id="sidebar-btns"></div></div>
    <div class="map-btn-group">
        <button class="map-ctrl-btn" onclick="toggleMapFullScreen()">å…¨é »/ç¸®å°</button>
        <button class="map-ctrl-btn" style="background:#2f9e44" onclick="downloadActive()">å„²å­˜ç·¨è¼¯ä¸¦ä¸‹è¼‰</button>
        <button class="map-ctrl-btn" style="background:#e03131" onclick="closeMap()">é—œé–‰é è¦½</button>
    </div>
    <div id="map"></div>

    <div id="bottom-editor">
        <div style="font-weight:bold; color:#2f9e44; text-align:center; margin-bottom:5px;" id="edit-label">æ­£åœ¨ç·¨è¼¯é»ä½</div>
        <div class="action-row">
            <button class="btn-act" style="background:#f1f3f5" onclick="rotatePoint(-15)">â†º è½‰å‹•</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="rotatePoint(15)">â†» è½‰å‹•</button>
            <button class="btn-act" style="background:#e7f5ff; color:#1971c2" onclick="cycleStart()">ğŸ“ åˆ‡æ›éŠœæ¥èµ·é»</button>
        </div>
        <div class="action-row">
            <button class="btn-act" style="background:#e03131; color:white" onclick="deletePoint()">ğŸ—‘ï¸ åˆªé™¤æ­¤çµ„</button>
            <button class="btn-act" style="background:#adb5bd; color:white" onclick="closeEditor()">å®Œæˆ</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    var map, currentData = [], activeLayers = {}, markers = [], activeModes = [], editingIdx = -1;

    function acceptNotice() { document.getElementById('bulletin-section').classList.add('is-hidden'); document.getElementById('generator-section').style.display = 'block'; }
    function showNotice() { document.getElementById('bulletin-section').classList.remove('is-hidden'); document.getElementById('generator-section').style.display = 'none'; }
    function toggleSource() { const type = document.getElementById('sourceType').value; document.getElementById('manualSection').classList.toggle('is-hidden', type !== 'manual'); document.getElementById('fileSection').classList.toggle('is-hidden', type === 'manual'); }
    function clearData() { document.getElementById('coordInput').value = ""; document.getElementById('gpxFile').value = ""; document.getElementById('status').innerText = "å·²æ¸…ç©º"; }
    function openMap() { document.getElementById('map-container').style.display = 'block'; if(!map) { map = L.map('map',{zoomControl:false}).setView([23.5,121],7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); L.control.zoom({position:'bottomright'}).addTo(map); } setTimeout(()=>map.invalidateSize(),400); }
    function closeMap() { document.getElementById('map-container').style.display = 'none'; closeEditor(); }
    function toggleMapFullScreen() { document.getElementById('map-container').classList.toggle('is-fullscreen'); setTimeout(()=>map.invalidateSize(),400); }
    function closeEditor() { document.getElementById('bottom-editor').style.display = 'none'; editingIdx = -1; markers.forEach(m => m.setStyle({color:'#fa5252', radius:8})); }

    async function processAll(preview) {
        const modes = Array.from(document.querySelectorAll('input[name="pathMode"]:checked')).map(el => el.value);
        if(!modes.length) return alert("è«‹å‹¾é¸æ¨¡å¼");
        try {
            let centers = [];
            const type = document.getElementById('sourceType').value;
            if(type === 'manual') {
                const txt = document.getElementById('coordInput').value;
                const matches = txt.match(/-?\d+\.\d+/g); //
                for(let i=0; i<matches.length; i+=2) centers.push({lng:parseFloat(matches[i+1]), lat:parseFloat(matches[i]), angle:0, offset:0});
            } else {
                const xml = await document.getElementById('gpxFile').files[0].text();
                const regex = /lat=["']([\d.-]+)["']\s+lon=["']([\d.-]+)["']/g;
                let m; while((m = regex.exec(xml))!==null) centers.push({lng:parseFloat(m[2]), lat:parseFloat(m[1]), angle:0, offset:0});
            }
            currentData = centers; activeModes = modes;
            if(!preview) { modes.forEach(m => exportGPX(getFinalPoly(m), m)); }
            else { openMap(); renderEditor(); }
        } catch(e) { alert("åº§æ¨™è§£æéŒ¯èª¤"); }
    }

    function renderEditor() {
        if(markers.length) markers.forEach(m => map.removeLayer(m)); markers = [];
        Object.values(activeLayers).forEach(layerGroup => map.removeLayer(layerGroup)); activeLayers = {};
        const sidebar = document.getElementById('sidebar-btns'); sidebar.innerHTML = "";
        document.getElementById('map-sidebar').classList.remove('is-hidden');

        activeModes.forEach((m, i) => {
            const layerGroup = L.featureGroup().addTo(map);
            activeLayers[m] = layerGroup;
            const sBtn = document.createElement('button');
            sBtn.className = "sidebar-btn" + (i === 0 ? " active" : "");
            sBtn.innerText = m === 'linear' ? "åº§æ¨™ä¸²æ¥" : m === 'z-shape' ? "Zå­—åœ–å½¢" : m === 'square' ? "æ­£æ–¹å½¢" : "æ¼æ–—å‹";
            sBtn.onclick = () => {
                Object.values(activeLayers).forEach(lg => lg.remove());
                layerGroup.addTo(map);
                document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
                sBtn.classList.add('active');
                closeEditor();
            };
            sidebar.appendChild(sBtn);
            if(i !== 0) map.removeLayer(layerGroup);
        });

        refreshPaths();
        if(currentData.length) map.fitBounds(L.featureGroup(markers).getBounds(), {padding:[50,50]});
    }

    function buildGroup(curr, mode, idx) {
        const r = 41; const cp = turf.point([curr.lng, curr.lat]);
        const v = [
            turf.destination(cp, r, curr.angle - 45, {units:'meters'}).geometry.coordinates, // TL (0)
            turf.destination(cp, r, curr.angle + 45, {units:'meters'}).geometry.coordinates, // TR (1)
            turf.destination(cp, r, curr.angle + 135, {units:'meters'}).geometry.coordinates, // BR (2)
            turf.destination(cp, r, curr.angle - 135, {units:'meters'}).geometry.coordinates  // BL (3)
        ];
        let shape;
        const C = [curr.lng, curr.lat];
        if (mode === 'funnel') shape = [C, v[0], v[1], C, v[3], v[2], C];
        else if (mode === 'z-shape') shape = [v[3], v[0], C, v[2], v[1]];
        else if (mode === 'square') shape = [v[3], v[0], v[1], v[2], v[3]];
        else return [C];

        // æ—‹è½‰èµ·é»é‚è¼¯ (Offset)
        if (mode !== 'funnel' && mode !== 'linear') {
            for (let k = 0; k < curr.offset; k++) {
                let first = shape.shift();
                shape.push(first);
            }
        }
        return shape;
    }

    function refreshPaths() {
        activeModes.forEach(mode => {
            const lg = activeLayers[mode];
            lg.clearLayers();
            const fullList = [];
            for (let i = 0; i < currentData.length; i++) {
                const group = buildGroup(currentData[i], mode, i);
                fullList.push(...group);

                // ç‚ºæ¯å€‹åœ–å½¢å€å¡Šå»ºç«‹ç¨ç«‹ Polyline ä»¥ä¾¿é»æ“Šç·¨è¼¯
                const poly = L.polyline(group.map(p => [p[1], p[0]]), {
                    color: '#1971c2', weight: 8, opacity: 0.7, lineJoin: 'round'
                }).addTo(lg);
                
                poly.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    triggerEdit(i);
                });

                // åŒæ­¥æ›´æ–°ç´…é»æ¨™è¨˜ (åƒ…é¦–å€‹æ¨¡å¼è² è²¬æ¨™è¨˜)
                if (mode === activeModes[0]) {
                    const m = L.circleMarker([currentData[i].lat, currentData[i].lng], {radius: 8, color:'#fa5252', fillOpacity: 1}).addTo(lg);
                    m.on('click', (e) => { L.DomEvent.stopPropagation(e); triggerEdit(i); });
                    markers.push(m);
                }
            }
            // ç¹ªè£½çµ„èˆ‡çµ„ä¹‹é–“çš„é€£æ¥ç·š
            if (fullList.length) {
                fullList.push(fullList[0]);
                L.polyline(fullList.map(p => [p[1], p[0]]), { color: '#1971c2', weight: 2, dashArray: '5, 10', opacity: 0.5 }).addTo(lg);
            }
        });
    }

    function triggerEdit(idx) {
        editingIdx = idx;
        markers.forEach((m, i) => m.setStyle({color: i === idx ? '#2f9e44' : '#fa5252', radius: i === idx ? 12 : 8}));
        document.getElementById('edit-label').innerText = `ç·¨è¼¯é»ä½ ${idx+1}`;
        document.getElementById('bottom-editor').style.display = 'flex';
    }

    function rotatePoint(v) { if(editingIdx < 0) return; currentData[editingIdx].angle = (currentData[editingIdx].angle + v) % 360; refreshPaths(); }
    function cycleStart() { if(editingIdx < 0) return; currentData[editingIdx].offset = (currentData[editingIdx].offset + 1) % 4; refreshPaths(); }
    function deletePoint() { if(editingIdx < 0) return; currentData.splice(editingIdx, 1); closeEditor(); renderEditor(); }

    function getFinalPoly(mode) {
        let path = [];
        currentData.forEach(curr => path.push(...buildGroup(curr, mode)));
        if (path.length) path.push(path[0]);
        return path;
    }

    function downloadActive() {
        const btn = document.querySelector('.sidebar-btn.active');
        const mKey = activeModes.find(m => btn.innerText.includes(m==='linear'?"ä¸²æ¥":m==='z-shape'?"Zå­—":m==='square'?"æ­£æ–¹":"æ¼æ–—"));
        exportGPX(getFinalPoly(mKey), mKey);
    }

    function exportGPX(pts, name) {
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><trk><name>${name}</name><trkseg>`;
        pts.forEach(pt => gpx += `\n<trkpt lat="${pt[1].toFixed(8)}" lon="${pt[0].toFixed(8)}"></trkpt>`);
        gpx += `\n</trkseg></trk></gpx>`;
        const blob = new Blob([gpx], { type: 'application/gpx+xml' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `pikmin_${name}_${Date.now()}.gpx`; a.click();
    }
</script>
</body>
</html>
