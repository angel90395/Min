<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>çš®å…‹æ•ç¨®èŠ±è·¯å¾‘ç”Ÿæˆä¿®æ”¹å™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --p-green: #2f9e44; --p-blue: #1971c2; --p-orange: #f08c00; --p-red: #e03131; --p-dark: #343a40; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f8f9fa; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; overflow: hidden; }
        
        /* é¸å–®æ¨£å¼ */
        #side-menu { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: white; z-index: 10005; transition: 0.3s; box-shadow: 2px 0 15px rgba(0,0,0,0.2); padding-top: 70px; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 18px 25px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; color: var(--p-dark); font-size: 15px; }
        #menu-btn { position: fixed; top: 15px; left: 15px; z-index: 10006; background: white; border: 2px solid var(--p-green); border-radius: 10px; padding: 8px 12px; cursor: pointer; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        #controls { width: 100%; height: 100%; padding: 20px; padding-top: 80px; padding-bottom: 160px; background: white; z-index: 100; overflow-y: auto; }
        .is-hidden { display: none !important; }
        #page-title { text-align: center; color: var(--p-green); margin-bottom: 20px; font-weight: 900; }

        /* ä½¿ç”¨å®ˆå‰‡ */
        #bulletin-section { background: #fff9db; border: 2px solid #fab005; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        #bulletin-section h4 { margin: 0 0 10px 0; color: #d9480f; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }
        #bulletin-section ul { padding-left: 20px; color: #444; font-size: 0.9rem; line-height: 1.6; }

        /* ä½¿ç”¨èªªæ˜èˆ‡å¡ç‰‡ */
        .instruction-card { background: #e7f5ff; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 6px solid var(--p-blue); }
        .instruction-card p { font-size: 0.85rem; color: #444; margin: 8px 0; line-height: 1.6; font-weight: bold; }
        .card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #dee2e6; border-left: 6px solid var(--p-green); }
        
        /* å¿«æ·æŒ‰éˆ• */
        .fast-act-row { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .btn-fast { flex: 1; padding: 12px 5px; font-size: 13px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #e9ecef; color: var(--p-dark); }

        /* åœ°åœ–æµ®å‹•è¦–çª—æ ¸å¿ƒæ¨£å¼ */
        #map-modal { 
            position: fixed; bottom: 20px; right: 20px; width: 340px; height: 420px; 
            background: white; z-index: 50000; display: none; border-radius: 20px; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.5); border: 4px solid white; overflow: hidden; transition: all 0.3s ease;
        }
        #map-modal.fullscreen { top: 0; left: 0; width: 100vw; height: 100vh; border-radius: 0; border: none; bottom: auto; right: auto; }
        #map { width: 100%; height: 100%; background: #ddd; }

        .map-ui-group { position: absolute; top: 15px; right: 15px; z-index: 50005; display: flex; flex-direction: column; gap: 8px; }
        .map-ctrl-btn { background: rgba(0,0,0,0.85); color: white; border: none; padding: 12px 14px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; }

        /* ä¿®æ”¹å·¥å…·é¢æ¿å›æ­¸ */
        #bottom-editor { position: absolute; bottom: 15px; left: 5%; width: 90%; background: white; z-index: 50010; border: 2.5px solid var(--p-green); border-radius: 20px; padding: 12px; display: none; flex-direction: column; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .action-row { display: flex; gap: 5px; justify-content: center; }
        .btn-act { flex: 1; padding: 12px 2px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 60000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 92%; max-width: 450px; }
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; z-index: 99999; display: none; }

        .number-icon { background: var(--p-red); border: 2.5px solid white; border-radius: 50%; color: white; font-weight: 800; text-align: center; font-size: 14px; width: 34px !important; height: 34px !important; display: flex; align-items: center; justify-content: center; }
        textarea { width: 100%; height: 180px; font-size: 16px; border: 1.5px solid #ced4da; border-radius: 10px; padding: 12px; }
        button.main-btn { width: 100%; padding: 22px; margin: 10px 0; border: none; border-radius: 15px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="toast">åº§æ¨™å·²è¤‡è£½</div>

<button id="menu-btn" onclick="toggleMenu()">â˜°</button>
<div id="side-menu">
    <div class="menu-item" onclick="navigate('guideline')">ä½¿ç”¨å®ˆå‰‡</div>
    <div class="menu-item" onclick="navigate('generator')">è·¯å¾‘ç”Ÿæˆå™¨</div>
    <div class="menu-item" onclick="navigate('modifier')">è·¯å¾‘ä¿®æ”¹å™¨</div>
    <div class="menu-item" onclick="navigate('feedback')">æ„è¦‹åé¥‹</div>
</div>

<div id="map-modal">
    <div id="map"></div>
    <div class="map-ui-group">
        <button class="map-ctrl-btn" id="modal-fs-btn" onclick="toggleMapModalFS()">å…¨é »æ¨¡å¼</button>
        <button class="map-ctrl-btn" style="background:var(--p-green)" onclick="triggerSaveFlow()">å„²å­˜ä¸‹è¼‰</button>
        <button class="map-ctrl-btn" style="background:var(--p-red)" onclick="closeMapModal()">é—œé–‰é è¦½</button>
    </div>
    <div id="bottom-editor">
        <div style="text-align:center; font-weight:bold; color:var(--p-green); font-size:13px; margin-bottom:5px;">æ­£åœ¨ç·¨è¼¯åº§æ¨™é»ä½</div>
        <div class="action-row">
            <button class="btn-act" style="background:var(--p-orange); color:white" onclick="togglePickingMode()">ğŸ‘† è‡ªé¸é †åº</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="moveSequence(-1)">â¬† å‰ç§»</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="moveSequence(1)">â¬‡ å¾Œç§»</button>
        </div>
        <div class="action-row">
            <button class="btn-act" style="background:#f1f3f5" onclick="rotatePoint(45)">â†» æ—‹è½‰åœ–å½¢</button>
            <button class="btn-act" style="background:#fd7e14; color:white; flex:1.2" onclick="restoreGlobal()">â® æ¢å¾©åŸå§‹</button>
            <button class="btn-act" style="background:var(--p-red); color:white" onclick="deletePoint()">ğŸ—‘ï¸ åˆªé™¤çµ„</button>
            <button class="btn-act" style="background:var(--p-dark); color:white" onclick="closeEditor()">å®Œæˆ</button>
        </div>
    </div>
</div>

<div id="save-dialog-overlay" class="overlay">
    <div class="modal-box">
        <h3 style="margin:0 0 10px; color:var(--p-green);">ç¢ºèªå„²å­˜åç¨±</h3>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 10px; margin: 15px 0; border: 2px solid var(--p-green); display:flex; align-items:center;">
            <input type="text" id="custom-filename" style="flex:1; border:none; background:none; outline:none; font-size:14px;">
            <span style="font-weight:bold; color:#adb5bd;">.gpx</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-act" style="background:#e9ecef" onclick="document.getElementById('save-dialog-overlay').style.display='none'">å–æ¶ˆ</button>
            <button class="btn-act" style="background:var(--p-green); color:white" onclick="confirmDownload()">å„²å­˜ä¸¦ä¸‹è¼‰</button>
        </div>
    </div>
</div>

<div id="coord-modal-overlay" class="overlay">
    <div class="modal-box">
        <h3 style="margin:0 0 10px; color:var(--p-orange);">åº§æ¨™æ¸…å–®é è¦½</h3>
        <textarea id="coord-modal-text" readonly style="height:250px; font-size:12px; background:#f8f9fa;"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-act" style="background:#e9ecef" onclick="document.getElementById('coord-modal-overlay').style.display='none'">é—œé–‰</button>
            <button class="btn-act" style="background:var(--p-orange); color:white" onclick="copyFromModal()">ä¸€éµè¤‡è£½å…¨éƒ¨</button>
        </div>
    </div>
</div>

<div id="controls">
    <h2 id="page-title">ä½¿ç”¨å®ˆå‰‡</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>å¤§å®¶éƒ½åœ¨ä¸Šç­ä¹‹é¤˜ç¨®èŠ±è‡ªçµ¦è‡ªè¶³æˆ–æŠ•é¤µæ–°æ‰‹ã€é™¸è»ï¼Œæ²’æœ‰æ™‚é–“ä½¿ç”¨é£›æ©Ÿæ¨¡å¼ç•«è·¯å¾‘ï¼Œé€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•é£›äººæ”¶æœã€ç¨®èŠ±çš„ GPX ç”Ÿæˆå™¨ï¼Œä½†è«‹ä¸è¦ç”¨ä¾†ç”¢ç”Ÿåˆ¥äººçš„èŠ±ç”°è·¯å¾‘ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„é£›äººã€‚</p>
        <h4>âš ï¸ è«‹éµå®ˆè‡ªå¾‹å®ˆå‰‡ï¼š</h4>
        <ul>
            <li>1.æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸å ç‚ºå·±ç”¨</li>
            <li>2.æœ‰é–‹èŠ±çš„ç”° åƒ…ç”Ÿæˆæ”¶æœè·¯ç·š</li>
            <li>3.ç”¢ç”Ÿçš„æª”æ¡ˆè«‹è‡ªç”¨ï¼Œä¸è¦åˆ†äº«ã€‚</li>
        </ul>
        <button class="main-btn" style="background:var(--p-green)" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="main-params-area" class="is-hidden">
        <div class="instruction-card">
            <h4>ğŸ“¢ ä½¿ç”¨èªªæ˜èˆ‡æé†’</h4>
            <p>æ‰‹å‹•è¼¸å…¥ï¼šå¡«å…¥åº§æ¨™ï¼ˆç·¯åº¦,ç¶“åº¦ï¼‰ï¼Œä¸€è¡Œä¸€å€‹</p>
            <p>ç”Ÿæˆè·¯å¾‘ä¸¦é è¦½åœ°åœ–ï¼šé€²å…¥æµ®å‹•åœ°åœ–ï¼Œå¯è‡ªé¸å…¨é »ä¿®æ”¹</p>
            <p>åº§æ¨™ç”Ÿæˆï¼šé¸å–æ­¤é …å¯å¿«é€Ÿç²å–å»é‡å¾Œçš„æ–‡å­—åº§æ¨™</p>
        </div>

        <div class="card" style="border-left-color: var(--p-orange);">
            <label style="font-weight:bold; margin-bottom:10px; display:block;">åº§æ¨™ä¾†æº</label>
            <select id="sourceType" onchange="handleSourceChange()" style="width:100%; padding:15px; border-radius:10px; border:1.5px solid #ced4da; font-size:16px;">
                <option value="">è«‹é¸æ“‡...</option>
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>

        <div id="manualInputContainer" class="card is-hidden">
            <textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦"></textarea>
            <div class="fast-act-row">
                <button class="btn-fast" onclick="handlePaste()">ğŸ“‹ è²¼ä¸Šå…§å®¹</button>
                <button class="btn-fast" onclick="handleSelectAll()">ğŸ” å…¨é¸</button>
                <button class="btn-fast" onclick="handleCopy()">âœ‚ï¸ è¤‡è£½</button>
                <button class="btn-fast" style="background:var(--p-orange); color:white;" onclick="document.getElementById('coordInput').value=''">æ¸…é™¤</button>
            </div>
        </div>

        <div id="fileInputContainer" class="card is-hidden" style="border-left-color: var(--p-orange);">
            <input type="file" id="gpxFile" accept=".gpx, application/gpx+xml, .xml, text/xml" style="width:100%; padding:10px;">
        </div>

        <div id="param-options" class="is-hidden">
            <div class="card">
                <label style="font-weight:bold; margin-bottom:10px; display:block;">é¸æ“‡æ¨¡å¼ (å¤šé¸)</label>
                <div id="mode-list" onchange="updateBtnUI()">
                    <label class="mode-option"><input type="checkbox" name="pathMode" value="linear" checked> èŠ±è‹—åº§æ¨™ä¸²é€£</label>
                    <label class="mode-option"><input type="checkbox" name="pathMode" value="z-shape"> Zå­—åœ–å½¢</label>
                    <label class="mode-option"><input type="checkbox" name="pathMode" value="s-shape"> Så‹åœ–å½¢</label>
                    <label class="mode-option"><input type="checkbox" name="pathMode" value="coord-gen"> åº§æ¨™ç”Ÿæˆ</label>
                </div>
            </div>

            <div class="card">
                <label style="font-weight:bold; margin-bottom:10px; display:block;">æ’åºæ–¹å¼</label>
                <div style="display: flex; gap: 15px;">
                    <label class="order-option"><input type="radio" name="orderType" value="original" checked> ç…§åŸå§‹é †åº</label>
                    <label class="order-option"><input type="radio" name="orderType" value="shortest"> æœ€çŸ­è·é›¢</label>
                </div>
            </div>

            <div id="main-btns-area">
                <button class="main-btn" style="background:var(--p-green)" id="btn-preview" onclick="processAll(true)">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
                <button class="main-btn" style="background:var(--p-blue)" id="btn-download" onclick="processAll(false)">ç›´æ¥ç”Ÿæˆ ä¸‹è¼‰ GPX</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    var map, currentData = [], rawBackup = [], activeLayers = {}, markers = [], activeModes = [], editingIdx = -1;
    var isPickingOrder = false, pickedSequence = [], pendingExport = null, isFS = false;

    const TW_FIX = { "æ„å¤§åˆ©": "ç¾©å¤§åˆ©", "æ„å¤§åˆ©å…±å’Œåœ‹": "ç¾©å¤§åˆ©", "æ„å¤§åˆ©å…±å’Œå›½": "ç¾©å¤§åˆ©" };

    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
    function navigate(v) {
        if (document.getElementById('side-menu').classList.contains('open')) toggleMenu();
        closeMapModal();
        document.getElementById('bulletin-section').classList.add('is-hidden');
        document.getElementById('main-params-area').classList.add('is-hidden');
        const titleEl = document.getElementById('page-title');
        if(v==='guideline') { document.getElementById('bulletin-section').classList.remove('is-hidden'); titleEl.innerText = "ä½¿ç”¨å®ˆå‰‡"; }
        else if(v==='generator') { document.getElementById('main-params-area').classList.remove('is-hidden'); titleEl.innerText = "è·¯å¾‘ç”Ÿæˆå™¨"; }
    }
    function acceptNotice() { navigate('generator'); }

    function handleSourceChange() {
        const type = document.getElementById('sourceType').value;
        document.getElementById('param-options').classList.toggle('is-hidden', !type);
        document.getElementById('manualInputContainer').classList.toggle('is-hidden', type !== 'manual');
        document.getElementById('fileInputContainer').classList.toggle('is-hidden', type !== 'file');
    }

    function updateBtnUI() {
        const checked = Array.from(document.querySelectorAll('input[name="pathMode"]:checked')).map(e => e.value);
        const onlyCoord = checked.length === 1 && checked[0] === 'coord-gen';
        document.getElementById('btn-preview').innerText = onlyCoord ? "ç”Ÿæˆå…¨éƒ¨åº§æ¨™" : "ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–";
        document.getElementById('btn-download').style.display = onlyCoord ? "none" : "block";
    }

    async function handlePaste() {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById('coordInput').value += text;
        } catch(e) {
            alert("å› ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œè«‹ã€Œé•·æŒ‰ã€è¼¸å…¥æ¡†å¾Œé»é¸ã€Œè²¼ä¸Šã€å³å¯ã€‚");
        }
    }
    function handleSelectAll() { const ta = document.getElementById('coordInput'); ta.focus(); ta.setSelectionRange(0, ta.value.length); }
    function handleCopy() { const ta = document.getElementById('coordInput'); ta.select(); document.execCommand('copy'); alert("å…§å®¹å·²è¤‡è£½"); }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = "block";
        setTimeout(() => { t.style.display = "none"; }, 2500);
    }

    // --- æ ¸å¿ƒè™•ç†ï¼šåœ°åœ–ä¿®å¾©èˆ‡è§£æ ---
    async function processAll(preview) {
        const type = document.getElementById('sourceType').value;
        let centers = [];
        try {
            if (type === 'manual') {
                const matches = document.getElementById('coordInput').value.match(/-?\d+\.\d+/g);
                if(!matches || matches.length < 2) return alert("åº§æ¨™è§£æç•°å¸¸ï¼Œè«‹ç¢ºèªæ ¼å¼ã€‚");
                for(let i=0; i<matches.length; i+=2) centers.push({lat: parseFloat(matches[i]), lng: parseFloat(matches[i+1]), angle: 0});
            } else {
                const f = document.getElementById('gpxFile').files[0];
                if(!f) return alert("è«‹é¸å–æª”æ¡ˆ");
                const xml = await f.text();
                const regex = /lat=["']([\d.-]+)["']\s+lon=["']([\d.-]+)["']/g;
                let m; while((m = regex.exec(xml))!==null) centers.push({lat: parseFloat(m[1]), lng: parseFloat(m[2]), angle: 0});
            }

            const seen = new Set();
            centers = centers.filter(item => {
                const k = `${item.lat.toFixed(6)},${item.lng.toFixed(6)}`;
                return seen.has(k) ? false : seen.add(k);
            });
            if (centers.length === 0) return alert("åº§æ¨™ç„¡æ•ˆã€‚");

            if(document.querySelector('input[name="orderType"]:checked').value === 'shortest') {
                const ctr = turf.center(turf.featureCollection(centers.map(p => turf.point([p.lng, p.lat])))).geometry.coordinates;
                centers.sort((a,b) => Math.atan2(a.lat-ctr[1], a.lng-ctr[0]) - Math.atan2(b.lat-ctr[1], b.lng-ctr[0]));
            }
            centers.forEach((c, i) => { const n = centers[(i + 1) % centers.length]; c.angle = turf.bearing(turf.point([c.lng, c.lat]), turf.point([n.lng, n.lat])); });
            currentData = centers; rawBackup = JSON.parse(JSON.stringify(centers));

            const modeEls = Array.from(document.querySelectorAll('input[name="pathMode"]:checked'));
            if(!modeEls.length) return alert("è«‹å‹¾é¸æ¨¡å¼");
            activeModes = modeEls.map(e => e.value);

            if (activeModes.includes('coord-gen')) {
                const coordStr = centers.map(c => `${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}`).join('\n');
                if (activeModes.length > 1) {
                    navigator.clipboard.writeText(coordStr); showToast("åº§æ¨™å·²è¤‡è£½");
                } else {
                    document.getElementById('coord-modal-text').value = coordStr;
                    document.getElementById('coord-modal-overlay').style.display = "flex";
                    return;
                }
            }

            if(preview) {
                document.getElementById('map-modal').style.display = 'block';
                // æ ¸å¿ƒä¿®å¾©ï¼šå»¶é²é‡ç¹ªç¢ºä¿ç°è‰²ç•«é¢æ¶ˆå¤±
                setTimeout(() => { 
                    if(!map) { map = L.map('map',{zoomControl:false}); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); }
                    map.invalidateSize(); 
                    renderEditor(); 
                }, 300);
            } else {
                const dlModes = activeModes.filter(m => m !== 'coord-gen');
                for(const m of dlModes) await startExportFlow(m);
            }
        } catch(e) { alert("è™•ç†ç•°å¸¸ï¼Œè«‹æª¢æŸ¥è³‡æ–™æ ¼å¼ã€‚"); }
    }

    function toggleMapModalFS() {
        const mm = document.getElementById('map-modal');
        const btn = document.getElementById('modal-fs-btn');
        if (mm.classList.contains('fullscreen')) {
            mm.classList.remove('fullscreen'); btn.innerText = "å…¨é »æ¨¡å¼";
        } else {
            mm.classList.add('fullscreen'); btn.innerText = "å°çª—æ¨¡å¼";
        }
        setTimeout(() => map.invalidateSize(), 300);
    }

    function closeMapModal() { document.getElementById('map-modal').style.display = 'none'; closeEditor(); }
    function copyFromModal() { const ta = document.getElementById('coord-modal-text'); ta.select(); document.execCommand('copy'); showToast("å·²è¤‡è£½å…¨éƒ¨åº§æ¨™"); }

    async function startExportFlow(modeKey) {
        pendingExport = { pts: getFinalPoly(modeKey), mode: modeKey };
        let countryZh = "å°ç£";
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentData[0].lat}&lon=${currentData[0].lng}&zoom=10&accept-language=zh-TW`, { signal: AbortSignal.timeout(1500) });
            const data = await res.json();
            countryZh = data.address.country || "å°ç£";
            for(let k in TW_FIX) { countryZh = countryZh.replace(k, TW_FIX[k]); }
        } catch(e) {}
        const now = new Date(); const dStr = now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0');
        const modeMap = { 'linear': 'æ”¶æœä¸²é€£', 'z-shape': 'Zå­—åœ–å½¢', 's-shape': 'Så‹åœ–å½¢' };
        document.getElementById('custom-filename').value = `pikmingpx_${modeMap[modeKey]}_${currentData.length}è‹—_${countryZh}_${dStr}_${Math.random().toString(36).substr(2,5)}`;
        document.getElementById('save-dialog-overlay').style.display = 'flex';
    }

    function confirmDownload() {
        const finalName = document.getElementById('custom-filename').value || "pikmin_path";
        const copyright = `é€™æ˜¯å°ˆç‚ºçš®å…‹æ•çš„ç©ºè»ç©å®¶æ‰“é€ çš„è·¯å¾‘å·¥å…·\nä¸»è¦æ˜¯æ–¹ä¾¿çš®å…‹æ•é£›äººç”¢ç”Ÿæ”¶æœã€ç¨®èŠ±çš„GPXç”Ÿæˆå™¨\nè«‹ä¸è¦ç”¨ä¾†ç”¢ç”Ÿåˆ¥äººçš„èŠ±ç”°è·¯å¾‘ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„é£›äºº\nhttps://flowergpx.pages.dev/`;
        let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n\n<gpx version="1.1" creator="PikminPathTool">\n<trk><name>${finalName}</name><desc>${copyright.replace(/\n/g,' ')}</desc><trkseg>\n`;
        pendingExport.pts.forEach(p => { gpx += `<trkpt lat="${p[1].toFixed(8)}" lon="${p[0].toFixed(8)}"></trkpt>\n`; });
        gpx += `</trkseg></trk></gpx>`;
        const blob = new Blob([gpx], { type: 'application/gpx+xml' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${finalName}.gpx`; a.click();
        document.getElementById('save-dialog-overlay').style.display = 'none';
    }

    function buildGroup(curr, mode) {
        const cp = turf.point([curr.lng, curr.lat]);
        if (mode === 'z-shape') {
            const r = 41; const v = { tl: turf.destination(cp, r, curr.angle-45, {units:'meters'}).geometry.coordinates, tr: turf.destination(cp, r, curr.angle+45, {units:'meters'}).geometry.coordinates, br: turf.destination(cp, r, curr.angle+135, {units:'meters'}).geometry.coordinates, bl: turf.destination(cp, r, curr.angle-135, {units:'meters'}).geometry.coordinates };
            return [v.tl, v.tr, [curr.lng, curr.lat], v.bl, v.br]; 
        } 
        if (mode === 's-shape') {
            const r = 30; const v = { tr: turf.destination(cp, r, curr.angle+45, {units:'meters'}).geometry.coordinates, tl: turf.destination(cp, r, curr.angle-45, {units:'meters'}).geometry.coordinates, ml: turf.destination(cp, r, curr.angle-90, {units:'meters'}).geometry.coordinates, mr: turf.destination(cp, r, curr.angle+90, {units:'meters'}).geometry.coordinates, br: turf.destination(cp, r, curr.angle+135, {units:'meters'}).geometry.coordinates, bl: turf.destination(cp, r, curr.angle-135, {units:'meters'}).geometry.coordinates };
            return [v.tr, v.tl, v.ml, [curr.lng, curr.lat], v.mr, v.br, v.bl];
        }
        return [[curr.lng, curr.lat]];
    }

    function refreshPaths() {
        const activeBtn = document.querySelector('.sidebar-btn.active'); if(!activeBtn) return;
        const mode = activeModes.find(m => activeBtn.innerText.includes(m==='linear'?'æ”¶æœ':m==='z-shape'?'Zå­—':'Så‹'));
        const lg = activeLayers[mode] || L.featureGroup().addTo(map); activeLayers[mode] = lg; lg.clearLayers();
        const fullTrack = [];
        for (let i = 0; i < currentData.length; i++) {
            L.circle([currentData[i].lat, currentData[i].lng], { radius: (mode === 'z-shape' ? 41 : 30), color: 'white', weight: 1.5, fillOpacity: 0.1, dashArray: '5, 5' }).addTo(lg);
            const group = buildGroup(currentData[i], mode); fullTrack.push(...group);
            const icon = L.divIcon({ className: 'number-icon' + (editingIdx === i ? ' selected' : ''), html: i+1, iconSize: [34, 34], iconAnchor: [17, 17] });
            L.marker([currentData[i].lat, currentData[i].lng], { icon }).addTo(lg).on('click', () => triggerEdit(i));
        }
        if (fullTrack.length) {
            fullTrack.push(fullTrack[0]); L.polyline(fullTrack.map(p => [p[1], p[0]]), { color: '#1971c2', weight: 6, opacity: 0.75 }).addTo(lg);
            map.fitBounds(lg.getBounds(), {padding:[50,50]});
        }
    }

    function renderEditor() {
        const sideBtns = document.getElementById('sidebar-btns') || document.createElement('div');
        sideBtns.id = 'sidebar-btns'; sideBtns.style.cssText = "position:absolute; top:15px; left:15px; z-index:50005; display:flex; flex-direction:column; gap:8px;";
        sideBtns.innerHTML = '';
        activeModes.filter(m => m !== 'coord-gen').forEach((m, i) => {
            const b = document.createElement('button'); b.className = "sidebar-btn" + (i === 0 ? " active" : "");
            b.style.cssText = "background:white; border:2px solid #ced4da; padding:12px; border-radius:12px; font-weight:bold; font-size:12px; cursor:pointer;";
            if(i===0) b.style.borderColor = "var(--p-green)";
            b.innerText = m==='linear'?"æ”¶æœä¸²é€£":m==='z-shape'?"Zå­—åœ–å½¢":"Så‹åœ–å½¢";
            b.onclick = () => { document.querySelectorAll('.sidebar-btn').forEach(x => x.style.borderColor = "#ced4da"); b.style.borderColor = "var(--p-green)"; b.classList.add('active'); refreshPaths(); };
            sideBtns.appendChild(b);
        });
        document.getElementById('map-modal').appendChild(sideBtns);
        refreshPaths();
    }

    function triggerEdit(idx) { editingIdx = idx; document.getElementById('bottom-editor').style.display='flex'; refreshPaths(); }
    function closeEditor() { document.getElementById('bottom-editor').style.display='none'; editingIdx=-1; refreshPaths(); }
    function deletePoint() { if(editingIdx < 0) return; currentData.splice(editingIdx, 1); closeEditor(); refreshPaths(); }
    function rotatePoint(v) { if(editingIdx < 0) return; currentData[editingIdx].angle = (currentData[editingIdx].angle + v) % 360; refreshPaths(); }
    function restoreGlobal() { currentData = JSON.parse(JSON.stringify(rawBackup)); closeEditor(); refreshPaths(); }
    function getFinalPoly(m) { let path = []; currentData.forEach(c => path.push(...buildGroup(c, m))); if (path.length) path.push(path[0]); return path; }
    function triggerSave() { const btn = document.querySelector('.sidebar-btn.active'); if(!btn) return; const m = activeModes.find(mk => btn.innerText.includes(mk==='linear'?'æ”¶æœ':mk==='z-shape'?'Zå­—':'Så‹')); startExportFlow(m); }
</script>
</body>
</html>
