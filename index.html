<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>çš®å…‹æ•ç¨®èŠ±æ”¶æœè·¯å¾‘ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --p-green: #2f9e44; --p-blue: #1971c2; --p-orange: #f08c00; --p-red: #e03131; --p-dark: #343a40; }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f8f9fa; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; overflow: hidden; -webkit-user-select: none; }
        
        /* 1. ä¸»æ§åˆ¶å€ä½ˆå±€å„ªåŒ–ï¼šè§£æ±ºæŒ‰éˆ•é®æ“‹å•é¡Œ */
        #controls { 
            width: 100%; min-height: 100vh; padding: 20px; 
            padding-bottom: 120px; /* å¤§é‡ç•™ç™½ï¼Œç¢ºä¿åº•éƒ¨æŒ‰éˆ•ä¸è¢«é®æ“‹ */
            background: white; z-index: 100; overflow-y: auto; position: relative; 
        }
        .is-hidden { display: none !important; }

        /* å®ˆå‰‡å…¬å‘Šæ¬„ */
        #bulletin-section { background: #fff9db; border: 2px solid #fab005; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        #bulletin-section h4 { margin: 0 0 10px 0; color: #d9480f; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }

        /* ç”Ÿæˆå™¨å€é è¨­éš±è— */
        #main-generator-area { display: none; }
        .instruction-card { background: #e7f5ff; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 6px solid var(--p-blue); }
        .instruction-card ol { margin: 0; padding-left: 20px; font-size: 0.85rem; color: #444; line-height: 1.6; }

        .card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #dee2e6; border-left: 6px solid var(--p-green); }
        .mode-option, .order-option { display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; }
        .mode-option input, .order-option input { margin-right: 12px; width: 20px; height: 20px; accent-color: var(--p-green); }

        /* åœ°åœ–è¦–çª— */
        #map-container { position: fixed; bottom: 20px; right: 20px; width: 340px; height: 340px; z-index: 999; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border-radius: 20px; border: 4px solid #fff; overflow: hidden; background: white; transition: 0.3s; }
        #map-container.is-fullscreen { top: 0; left: 0; width: 100vw; height: 100vh; border-radius: 0; border: none; z-index: 9999; }
        #map { width: 100%; height: 100%; z-index: 1; }

        .map-btn-group { position: absolute; top: 100px; right: 15px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        #map-container.is-fullscreen .map-btn-group { top: 20px; }
        .map-ctrl-btn { background: rgba(0,0,0,0.85); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; backdrop-filter: blur(4px); }

        /* çµ±è¨ˆèˆ‡èª¿é€Ÿ */
        #map-sidebar-wrapper { position: absolute; top: 120px; left: 15px; z-index: 2000; display: flex; flex-direction: column; width: 195px; }
        #map-container.is-fullscreen #map-sidebar-wrapper { top: 20px; }
        #stat-panel { background: var(--p-dark); padding: 12px; border-radius: 10px; color: white; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .stat-line { font-size: 11px; font-weight: bold; margin: 3px 0; display: flex; align-items: center; justify-content: flex-start; gap: 8px; }
        .speed-ctrl { display: flex; gap: 5px; align-items: center; background: #495057; border-radius: 6px; padding: 2px 6px; }
        .speed-btn { background: none; border: none; color: white; font-weight: bold; font-size: 16px; cursor: pointer; padding: 0 4px; }

        #map-sidebar { background: rgba(255,255,255,0.95); border-radius: 12px; padding: 6px; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sidebar-btn { background: #fff; border: 1px solid #ced4da; padding: 10px; border-radius: 6px; font-size: 10px; font-weight: bold; text-align: left; cursor: pointer; }
        .sidebar-btn.active { background: var(--p-green); color: white; border-color: var(--p-green); }

        /* 2. åº•éƒ¨ç·¨è¼¯æ¢å„ªåŒ–ï¼šç‰©ç†ä¸Šç§»é¿å…å…¨é »é®æ“‹ */
        #bottom-editor { 
            position: absolute; 
            bottom: 130px; /* å¤§å¹…ä¸Šç§»ï¼Œè§£æ±ºè¢«ç³»çµ±æ“‹ä½å•é¡Œ */
            left: 5%; width: 90%; 
            background: white; z-index: 10001; 
            border: 2.5px solid var(--p-green); border-radius: 20px;
            padding: 15px 12px; 
            display: none; flex-direction: column; gap: 10px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); 
        }
        #edit-label { font-size: 12px; font-weight: bold; color: var(--p-green); text-align: center; margin-bottom: 5px; }
        .action-row { display: flex; gap: 6px; justify-content: center; width: 100%; }
        .btn-act { flex: 1; padding: 12px 2px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; }

        .number-icon { background: var(--p-red); border: 2.5px solid white; border-radius: 50%; color: white; font-weight: 800; text-align: center; font-size: 14px; width: 34px !important; height: 34px !important; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 8px rgba(0,0,0,0.3); }
        .number-icon.selected { background: var(--p-green); transform: scale(1.15); z-index: 1000 !important; }

        textarea { width: 100%; height: 100px; font-size: 14px; border: 1.5px solid #ced4da; border-radius: 8px; padding: 12px; }
        button.main-btn { width: 100%; padding: 18px; margin: 10px 0; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: 0.2s; }
        button.main-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>

<script>
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.onkeydown = function(e) {
        if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || (e.ctrlKey && e.keyCode == 85)) return false;
    };
    setInterval(function() {
        const start = new Date(); debugger;
        if (new Date() - start > 100) window.location.href = "about:blank";
    }, 1000);
</script>

<div id="controls">
    <h2 style="margin: 0 0 20px; text-align: center; color: var(--p-green);">çš®å…‹æ•ç¨®èŠ±æ”¶æœè·¯å¾‘ç”Ÿæˆå™¨</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>å¤§å®¶éƒ½åœ¨ä¸Šç­ä¹‹é¤˜ç¨®èŠ±è‡ªçµ¦è‡ªè¶³æˆ–æŠ•é¤µæ–°æ‰‹ã€é™¸è»ï¼Œæ²’æœ‰æ™‚é–“ä½¿ç”¨é£›æ©Ÿæ¨¡å¼ç•«è·¯å¾‘ï¼Œé€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•é£›äººæ”¶æœã€ç¨®èŠ±çš„ GPX ç”Ÿæˆå™¨ã€‚</p>
        <h4>âš ï¸ è«‹éµå®ˆè‡ªå¾‹å®ˆå‰‡ï¼š</h4>
        <ul>
            <li>1.æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸å ç‚ºå·±ç”¨</li>
            <li>2.æœ‰é–‹èŠ±çš„ç”° åƒ…ç”Ÿæˆæ”¶æœè·¯ç·š</li>
            <li>3.ç”¢ç”Ÿçš„æª”æ¡ˆè«‹è‡ªç”¨ï¼Œä¸è¦åˆ†äº«ã€‚</li>
        </ul>
        <button class="main-btn" style="background:var(--p-green)" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="main-generator-area">
        <div class="instruction-card">
            <h4>ğŸ“¢ ä½¿ç”¨èªªæ˜èˆ‡æé†’</h4>
            <ol>
                <li>æ‰‹å‹•è¼¸å…¥ï¼šå°‡åº§æ¨™ä¾åºè²¼å…¥ï¼Œä¸€è¡Œä¸€å€‹ã€‚</li>
                <li>åº§æ¨™æŸ¥çœ‹ï¼šé»æ“Šåœ°åœ–ç´…é»å¯é¡¯ç¤ºåº§æ¨™ä¸¦é–‹å•Ÿç·¨è¼¯é¢æ¿ã€‚</li>
                <li>è‡ªé¸é †åºï¼šå†æ¬¡é»æ“Šå·²é¸è™Ÿé»å¯å–æ¶ˆé¸å–æ¢å¾©ç‚º "?"ã€‚</li>
                <li>è‡ªå‹•è¼‰å…¥ï¼šç”Ÿæˆå¾Œåœ°åœ–æœƒè‡ªå‹•é¡¯ç¤ºç¬¬ä¸€å€‹å‹¾é¸æ¨¡å¼çš„ç·šæ¢ã€‚</li>
            </ol>
        </div>
        
        <div class="card">
            <label style="font-weight:bold; margin-bottom:10px; display:block;">1. é¸æ“‡æ¨¡å¼ (å¯è¤‡é¸)</label>
            <label class="mode-option"><input type="checkbox" name="pathMode" value="linear" checked> èŠ±è‹—åº§æ¨™ä¸²é€£(é©åˆæ”¶æœ)</label>
            <label class="mode-option"><input type="checkbox" name="pathMode" value="z-shape"> Zå­—åœ–å½¢</label>
            <label class="mode-option"><input type="checkbox" name="pathMode" value="s-shape"> Så‹åœ–å½¢(ç´„å‰©113-129èŠ±ç“£)</label>
        </div>

        <div class="card" style="border-left-color: var(--p-orange);">
            <label style="font-weight:bold; margin-bottom:10px; display:block;">2. æ’åºæ–¹å¼</label>
            <div style="display: flex; gap: 15px;">
                <label class="order-option"><input type="radio" name="orderType" value="original" checked> ç…§åŸå§‹é †åº</label>
                <label class="order-option"><input type="radio" name="orderType" value="shortest"> æœ€çŸ­è·é›¢</label>
            </div>
        </div>

        <div class="card" style="border-left-color: #fcc419;">
            <select id="sourceType" onchange="toggleSource()" style="width:100%; padding:10px; border-radius:8px;">
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>

        <div id="manualSection" class="card">
            <textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦"></textarea>
            <button class="main-btn" style="background:var(--p-orange); padding:10px; font-size:14px; margin-top:5px;" onclick="clearData()">æ¸…é™¤è¼¸å…¥è³‡æ–™</button>
        </div>

        <div id="fileSection" class="card is-hidden" style="border-left-color: #fcc419;">
            <input type="file" id="gpxFile" accept=".gpx,.xml" style="width: 100%; padding: 10px;">
        </div>

        <button class="main-btn" style="background:var(--p-green)" onclick="processAll(true)">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
        <button class="main-btn" style="background:var(--p-blue)" onclick="processAll(false)">ç›´æ¥ç”Ÿæˆ ä¸‹è¼‰ GPX</button>
    </div>
</div>

<div id="map-container">
    <div id="map-sidebar-wrapper" class="is-hidden">
        <div id="stat-panel">
            <div class="stat-line" id="dist-val">ç¸½è·é›¢ï¼š0.00 km</div>
            <div class="stat-line">æ™‚é€Ÿï¼š
                <div class="speed-ctrl">
                    <button class="speed-btn" onclick="adjustSpeed(-1)">-</button>
                    <span id="speed-val">20</span>
                    <button class="speed-btn" onclick="adjustSpeed(1)">+</button>
                </div>
            </div>
            <div class="stat-line" id="time-val">é è¨ˆæ™‚é–“ï¼š0 min</div>
        </div>
        <div id="map-sidebar"><div id="sidebar-btns"></div></div>
    </div>

    <div class="map-btn-group">
        <button class="map-ctrl-btn" onclick="toggleSize()">å…¨é »/ç¸®å°</button>
        <button class="map-ctrl-btn" style="background:var(--p-green)" id="btn-final-dl" onclick="downloadActive()">å„²å­˜ä¸‹è¼‰</button>
        <button class="map-ctrl-btn" style="background:var(--p-red)" onclick="closeMap()">é—œé–‰é è¦½</button>
    </div>
    <div id="map"></div>

    <div id="bottom-editor">
        <div id="edit-label">ç·¨è¼¯é¢æ¿</div>
        <div class="action-row">
            <button class="btn-act" style="background:var(--p-orange); color:white" onclick="togglePickingMode()">ğŸ‘† è‡ªé¸é †åº</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="moveSequence(-1)">â¬† å‰ç§»</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="moveSequence(1)">â¬‡ å¾Œç§»</button>
        </div>
        <div class="action-row">
            <button class="btn-act" style="background:#f1f3f5" onclick="rotatePoint(45)">â†» æ—‹è½‰</button>
            <button class="btn-act" style="background:#fd7e14; color:white; flex: 1.2" onclick="restoreGlobalOriginal()">â® æ¢å¾©åŸå§‹</button>
            <button class="btn-act" style="background:var(--p-red); color:white" id="btn-del" onclick="deletePoint()">ğŸ—‘ï¸ åˆªé™¤çµ„</button>
            <button class="btn-act" style="background:var(--p-dark); color:white" onclick="closeEditor()">å®Œæˆ</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    var map, currentData = [], rawBackup = [], activeLayers = {}, markers = [], rangeCircles = [], activeModes = [], editingIdx = -1;
    var isPickingOrder = false, pickedSequence = [], currentSpeed = 20;

    function acceptNotice() { document.getElementById('bulletin-section').style.display = 'none'; document.getElementById('main-generator-area').style.display = 'block'; }
    function toggleSource() { const t = document.getElementById('sourceType').value; document.getElementById('manualSection').classList.toggle('is-hidden', t!=='manual'); document.getElementById('fileSection').classList.toggle('is-hidden', t==='manual'); }
    function clearData() { document.getElementById('coordInput').value = ""; document.getElementById('gpxFile').value = ""; }
    function closeMap() { document.getElementById('map-container').style.display = 'none'; closeEditor(); }
    function toggleSize() { const c = document.getElementById('map-container'); c.classList.toggle('is-fullscreen'); setTimeout(() => { if(map) map.invalidateSize(); }, 400); }
    function closeEditor() { document.getElementById('bottom-editor').style.display = 'none'; editingIdx = -1; isPickingOrder = false; refreshPaths(); }
    function adjustSpeed(val) { currentSpeed = Math.max(1, currentSpeed + val); document.getElementById('speed-val').innerText = currentSpeed; refreshPaths(); }

    function openMap() {
        document.getElementById('map-container').style.display = 'block';
        if (!map) { map = L.map('map',{zoomControl:false}); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); L.control.zoom({position:'bottomright'}).addTo(map); }
        setTimeout(() => { map.invalidateSize(); if(currentData.length) map.fitBounds(L.featureGroup(markers).getBounds(), {padding:[50,50]}); }, 500);
    }

    async function processAll(preview) {
        const modes = Array.from(document.querySelectorAll('input[name="pathMode"]:checked')).map(el => el.value);
        if(!modes.length) return alert("è«‹å‹¾é¸æ¨¡å¼");
        try {
            let centers = [];
            if(document.getElementById('sourceType').value === 'manual') {
                const matches = document.getElementById('coordInput').value.match(/-?\d+\.\d+/g);
                for(let i=0; i<matches.length; i+=2) centers.push({lng:parseFloat(matches[i+1]), lat:parseFloat(matches[i]), angle:0});
            } else {
                const f = document.getElementById('gpxFile').files[0];
                const xml = await f.text();
                const regex = /lat=["']([\d.-]+)["']\s+lon=["']([\d.-]+)["']/g;
                let m; while((m = regex.exec(xml))!==null) centers.push({lng:parseFloat(m[2]), lat:parseFloat(m[1]), angle:0});
            }
            if(document.querySelector('input[name="orderType"]:checked').value === 'shortest') {
                const ctr = turf.center(turf.featureCollection(centers.map(p => turf.point([p.lng, p.lat])))).geometry.coordinates;
                centers.sort((a,b) => Math.atan2(a.lat-ctr[1], a.lng-ctr[0]) - Math.atan2(b.lat-ctr[1], b.lng-ctr[0]));
            }
            centers.forEach((c, i) => { const n = centers[(i + 1) % centers.length]; c.angle = turf.bearing(turf.point([c.lng, c.lat]), turf.point([n.lng, n.lat])); });
            currentData = centers; rawBackup = JSON.parse(JSON.stringify(centers)); activeModes = modes;
            if(!preview) { for(const m of modes) await exportGPX(getFinalPoly(m), m); }
            else { renderEditor(); openMap(); }
        } catch(e) { alert("è™•ç†å‡ºéŒ¯"); }
    }

    function renderEditor() {
        document.getElementById('sidebar-btns').innerHTML = "";
        Object.values(activeLayers).forEach(lg => lg.remove()); activeLayers = {};
        document.getElementById('map-sidebar-wrapper').classList.remove('is-hidden');
        let firstBtn = null;
        activeModes.forEach((m, i) => {
            const lg = L.featureGroup(); activeLayers[m] = lg;
            const b = document.createElement('button'); b.className = "sidebar-btn" + (i === 0 ? " active" : "");
            b.innerText = m==='linear'?"æ”¶æœä¸²é€£":m==='z-shape'?"Zå­—åœ–å½¢":"Så‹åœ–å½¢";
            b.onclick = () => { Object.values(activeLayers).forEach(l => l.remove()); lg.addTo(map); document.querySelectorAll('.sidebar-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); closeEditor(); };
            document.getElementById('sidebar-btns').appendChild(b);
            if(i === 0) firstBtn = b;
        });
        refreshPaths();
        if(firstBtn && map) setTimeout(() => firstBtn.click(), 150);
    }

    function buildGroup(curr, mode) {
        const cp = turf.point([curr.lng, curr.lat]);
        const C = [curr.lng, curr.lat];
        if (mode === 'z-shape') {
            const r = 41; const v = { tl: turf.destination(cp, r, curr.angle-45, {units:'meters'}).geometry.coordinates, tr: turf.destination(cp, r, curr.angle+45, {units:'meters'}).geometry.coordinates, br: turf.destination(cp, r, curr.angle+135, {units:'meters'}).geometry.coordinates, bl: turf.destination(cp, r, curr.angle-135, {units:'meters'}).geometry.coordinates, mr: turf.destination(cp, r, curr.angle+90, {units:'meters'}).geometry.coordinates };
            return [v.tl, v.tr, C, v.bl, v.br, v.mr];
        } 
        if (mode === 's-shape') {
            const r = 30; const v = { tr: turf.destination(cp, r, curr.angle+45, {units:'meters'}).geometry.coordinates, tl: turf.destination(cp, r, curr.angle-45, {units:'meters'}).geometry.coordinates, ml: turf.destination(cp, r, curr.angle-90, {units:'meters'}).geometry.coordinates, mr: turf.destination(cp, r, curr.angle+90, {units:'meters'}).geometry.coordinates, br: turf.destination(cp, r, curr.angle+135, {units:'meters'}).geometry.coordinates, bl: turf.destination(cp, r, curr.angle-135, {units:'meters'}).geometry.coordinates };
            return [v.tr, v.tl, v.ml, C, v.mr, v.br, v.bl];
        }
        return [C];
    }

    function refreshPaths() {
        const activeBtn = document.querySelector('.sidebar-btn.active'); if(!activeBtn) return;
        const mode = activeModes.find(m => activeBtn.innerText.includes(m==='linear'?"æ”¶æœ":m==='z-shape'?"Zå­—":"Så‹"));
        const lg = activeLayers[mode]; if(!lg) return;
        lg.clearLayers(); rangeCircles.forEach(c => map?.removeLayer(c)); rangeCircles = [];
        const fullTrack = [];
        for (let i = 0; i < currentData.length; i++) {
            const r = (mode === 'z-shape') ? 41 : 30;
            L.circle([currentData[i].lat, currentData[i].lng], { radius: r, color: 'white', weight: 1.5, fillOpacity: 0.1, dashArray: '5, 5' }).addTo(lg);
            const group = buildGroup(currentData[i], mode); fullTrack.push(...group);
            const pIdx = pickedSequence.indexOf(i);
            const icon = L.divIcon({ className: 'number-icon' + (editingIdx === i ? ' selected' : ''), html: isPickingOrder ? (pIdx !== -1 ? pIdx+1 : "?") : i+1, iconSize: [34, 34], iconAnchor: [17, 17] });
            const m = L.marker([currentData[i].lat, currentData[i].lng], { icon: icon }).addTo(lg);
            m.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMarkerClick(i); }); markers[i] = m;
        }
        if (fullTrack.length) {
            fullTrack.push(fullTrack[0]); L.polyline(fullTrack.map(p => [p[1], p[0]]), { color: '#1971c2', weight: 6, opacity: 0.75 }).addTo(lg);
            const dist = turf.length(turf.lineString(fullTrack), {units: 'kilometers'});
            document.getElementById('dist-val').innerText = `ç¸½è·é›¢ï¼š${dist.toFixed(2)} km`;
            document.getElementById('time-val').innerText = `é è¨ˆæ™‚é–“ï¼š${Math.ceil((dist/currentSpeed)*60)} min`;
        }
    }

    function togglePickingMode() { isPickingOrder = !isPickingOrder; pickedSequence = []; refreshPaths(); }
    
    // ä¿®å¾©ï¼šå†æ¬¡é»é¸å·²é¸é»ä½å–æ¶ˆåºè™Ÿ
    function handleMarkerClick(idx) {
        if (!isPickingOrder) { triggerEdit(idx); return; }
        const pIdx = pickedSequence.indexOf(idx);
        if (pIdx !== -1) pickedSequence.splice(pIdx, 1); else pickedSequence.push(idx);
        refreshPaths();
        if (pickedSequence.length === currentData.length && currentData.length > 0) { currentData = pickedSequence.map(i => currentData[i]); togglePickingMode(); refreshPaths(); }
    }

    function triggerEdit(idx) { editingIdx = idx; document.getElementById('edit-label').innerText = `æ­£åœ¨ç·¨è¼¯ç¬¬ ${idx+1} çµ„ (${currentData[idx].lat.toFixed(6)}, ${currentData[idx].lng.toFixed(6)})`; document.getElementById('bottom-editor').style.display = 'flex'; refreshPaths(); }
    function deletePoint() { if(editingIdx < 0) return; currentData.splice(editingIdx, 1); closeEditor(); renderEditor(); }
    function moveSequence(dir) { if(editingIdx < 0) return; const n = editingIdx + dir; if(n >= 0 && n < currentData.length) { [currentData[editingIdx], currentData[n]] = [currentData[n], currentData[editingIdx]]; editingIdx = n; refreshPaths(); triggerEdit(n); } }
    function rotatePoint(v) { if(editingIdx < 0) return; currentData[editingIdx].angle = (currentData[editingIdx].angle + v) % 360; refreshPaths(); }
    function restoreGlobalOriginal() { if(confirm("é‚„åŸè·¯å¾‘è¨­å®šï¼Ÿ")) { currentData = JSON.parse(JSON.stringify(rawBackup)); closeEditor(); renderEditor(); } }
    function getFinalPoly(m) { let path = []; currentData.forEach(c => path.push(...buildGroup(c, m))); if (path.length) path.push(path[0]); return path; }

    async function exportGPX(pts, modeKey) {
        const names = { 'linear': 'æ”¶æœä¸²é€£', 'z-shape': 'Zå­—åœ–å½¢', 's-shape': 'Så‹åœ–å½¢' };
        const modeChi = names[modeKey] || modeKey;
        const count = currentData.length;
        const now = new Date(); const dStr = now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0');
        let c_en = "Region", c_zh = "åœ°å€", a_zh = "";
        const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 3000); 
        try {
            const rZh = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentData[0].lat}&lon=${currentData[0].lng}&zoom=10&accept-language=zh-TW`, { signal: controller.signal });
            const dZh = await rZh.json();
            c_zh = dZh.address.country || "æœªçŸ¥"; a_zh = dZh.address.city || dZh.address.town || dZh.address.state || "";
            const rEn = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentData[0].lat}&lon=${currentData[0].lng}&zoom=3&accept-language=en`, { signal: controller.signal });
            const dEn = await rEn.json(); c_en = dEn.address.country || "Country";
            clearTimeout(timeoutId);
        } catch(e) {}
        const pathName = `(${modeChi})${c_zh}${a_zh}${count}è‹—`;
        const fileName = `pikmingpx_${modeKey}_${count}è‹—_${c_en.replace(/\s+/g,'')}_${c_zh}_${dStr}_${Math.random().toString(36).substr(2,5)}.gpx`;
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><trk><name>${pathName}</name><trkseg>`;
        pts.forEach(p => gpx += `\n<trkpt lat="${p[1].toFixed(8)}" lon="${p[0].toFixed(8)}"></trkpt>`);
        gpx += `\n</trkseg></trk></gpx>`;
        const b = new Blob([gpx], { type: 'application/gpx+xml' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fileName; a.click();
    }
    async function downloadActive() { const btn = document.querySelector('.sidebar-btn.active'); if(!btn) return; const m = activeModes.find(m => btn.innerText.includes(m==='linear'?"æ”¶æœ":m==='z-shape'?"Zå­—":"Så‹")); await exportGPX(getFinalPoly(m), m); }
</script>
</body>
</html>
