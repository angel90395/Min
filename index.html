<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>çš®å…‹æ•æ”¶æœç¨®èŠ±è·¯å¾‘ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f0f4f8; overflow-x: hidden; }
        body { display: flex; flex-direction: column; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; }

        #controls { width: 100%; min-height: 100vh; padding: 15px; background: white; z-index: 100; overflow-y: auto; transition: 0.3s; }
        .is-hidden { display: none !important; }

        /* å…¬å‘Šæ¬„ */
        #bulletin-section { 
            background: #fff9db; border: 1px solid #fab005; border-radius: 12px; 
            padding: 20px; margin-bottom: 15px; font-size: 0.95rem; color: #444; line-height: 1.7;
        }
        #bulletin-section h4 { margin: 15px 0 8px 0; color: #d9480f; font-size: 1.1rem; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }
        #bulletin-section ul { margin: 10px 0; padding-left: 20px; }

        /* ä½¿ç”¨èªªæ˜å¡ */
        .instruction-card { 
            background: #e7f5ff; border: 1px solid #a5d8ff; border-radius: 10px; 
            padding: 15px; margin-bottom: 15px; font-size: 0.9rem; color: #1864ab;
        }
        .instruction-card h4 { margin: 0 0 8px 0; color: #1971c2; }
        .instruction-card ul { margin: 5px 0; padding-left: 18px; }

        #generator-section { display: none; }

        /* æ ¸å–æ–¹å¡Šæ¨£å¼ */
        .mode-option {
            display: flex; align-items: center; background: #f8f9fa;
            padding: 12px; border-radius: 8px; margin-bottom: 8px;
            border: 1px solid #dee2e6; cursor: pointer; font-size: 0.95rem;
        }
        .mode-option input { margin-right: 12px; width: 22px; height: 22px; }

        /* --- æµ®è²¼å¼åœ°åœ–å®¹å™¨ --- */
        #map-container {
            position: fixed; bottom: 20px; right: 20px;
            width: 320px; height: 320px;
            z-index: 99999; display: none;
            box-shadow: 0 4px 25px rgba(0,0,0,0.4);
            border-radius: 15px; border: 3px solid #fff; overflow: hidden;
            transition: all 0.4s ease;
        }
        #map-container.is-fullscreen { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; border: none; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* åœ°åœ–æ§åˆ¶æŒ‰éˆ• (ä¸‹ç§»é¿é–‹ç³»çµ±åˆ—) */
        .map-btn-group {
            position: absolute; top: 80px; right: 15px; z-index: 100000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .map-ctrl-btn {
            background: rgba(33, 37, 41, 0.9); color: white; border: none;
            padding: 10px 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px;
        }
        .btn-close-map { background: #e03131 !important; }

        /* --- åœ°åœ–å´é‚Šé è¦½é¸å–® --- */
        #map-sidebar {
            position: absolute; top: 80px; left: 10px; z-index: 100000;
            background: rgba(255,255,255,0.9); border-radius: 8px;
            padding: 8px; display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 140px;
        }
        .sidebar-title { font-size: 11px; font-weight: bold; color: #666; margin-bottom: 2px; }
        .sidebar-btn {
            background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 5px;
            font-size: 12px; cursor: pointer; text-align: left; transition: 0.2s;
        }
        .sidebar-btn.active { background: #2f9e44; color: white; border-color: #2f9e44; }

        .card { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6; border-left: 6px solid #2f9e44; }
        .card-y { border-left-color: #fcc419; }
        label { font-weight: bold; font-size: 0.9rem; color: #343a40; display: block; margin-bottom: 5px; }
        textarea { width: 100%; height: 80px; font-size: 14px; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; font-family: monospace; }
        
        button { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.2s; }
        .btn-agree { background: #2f9e44; color: white; }
        .btn-view-notice { background: #f8f9fa; color: #495057; border: 1px solid #ced4da; margin-bottom: 10px; }
        .btn-gen { background: #2f9e44; color: white; }
        .btn-clear { background: #f08c00; color: white; margin-top: 5px; } 
        #download-area { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .btn-dl { background: #1971c2; color: white; font-size: 14px; padding: 12px; }
        
        #status { font-size: 13px; color: #fa5252; text-align: center; margin-top: 8px; font-weight: bold; }

        @media (min-width: 768px) {
            #controls { width: 450px; }
            #map-container { width: 450px; height: 450px; }
            .map-btn-group { top: 20px; flex-direction: row; }
            #map-sidebar { top: 20px; }
        }
    </style>
</head>
<body id="mainBody">

<div id="controls">
    <h2 style="margin: 0 0 20px; text-align: center; color: #2f9e44;">çš®å…‹æ•æ”¶æœç¨®èŠ±è·¯å¾‘ç”Ÿæˆå™¨</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>å¤§å®¶éƒ½åœ¨ä¸Šç­ä¹‹é¤˜ç¨®èŠ±è‡ªçµ¦è‡ªè¶³æˆ–æŠ•é¤µæ–°æ‰‹ã€é™¸è»ï¼Œæ²’æœ‰æ™‚é–“ä½¿ç”¨é£›æ©Ÿå…§æ—¢æœ‰çš„æ¨¡å¼ç•«è·¯å¾‘ï¼Œæ‰€ä»¥é€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•é£›äººæ”¶æœã€ç¨®èŠ±çš„GPXç”Ÿæˆå™¨ï¼Œä½†è«‹ä¸è¦ç”¨ä¾†ç”¢ç”Ÿåˆ¥äººçš„èŠ±ç”°è·¯å¾‘ç¨®èŠ±ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„çš®å…‹æ•é£›äººã€‚</p>
        <h4>âš ï¸ è«‹éµå®ˆä»¥ä¸‹å¹¾é»ï¼š</h4>
        <ul>
            <li>1.æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸ç”¢ç”Ÿè·¯å¾‘ ä¸å ç‚ºå·±ç”¨</li>
            <li>2.æœ‰é–‹èŠ±çš„ç”°æˆ–æœ‰å›ºå®šç¨®èŠ±ä¸»çš„ç”° åƒ…ç”Ÿæˆæ”¶æœè·¯ç·š åœ¨é–‹å¤§èŠ±æœŸé–“æ‰è·‘è·¯å¾‘æ”¶èŠ±</li>
            <li>3.ç”¢ç”Ÿçš„æª”æ¡ˆéƒ½è«‹è‡ªç”¨ï¼Œä¸è¦åˆ†äº«ï¼Œå°¤å…¶æ˜¯åˆ¥äººç”°çš„è·¯å¾‘æª”</li>
        </ul>
        <button class="btn-agree" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="generator-section">
        <button class="btn-view-notice" onclick="showNotice()">æŸ¥çœ‹å…¬å‘Šèªªæ˜</button>

        <div class="instruction-card">
            <h4>ğŸ“¢ ä½¿ç”¨èªªæ˜èˆ‡æé†’</h4>
            <ul>
                <li>1. <b>æ‰‹å‹•è¼¸å…¥ï¼š</b>å°‡åº§æ¨™ä¾åºè²¼å…¥ï¼Œä¸€è¡Œä¸€å€‹ã€‚</li>
                <li>2. <b>ä¸Šå‚³æª”æ¡ˆï¼š</b>å¯ä¸Šå‚³æ—¢æœ‰çš„æ”¶æœè·¯ç·šgpxï¼Œæœƒä¿ç•™åŸé †åºã€‚</li>
                <li>3. <b>è¤‡é¸æ¨¡å¼ï¼š</b>å¯åŒæ™‚å‹¾é¸å¤šç¨®æ¨¡å¼ï¼Œåœ°åœ–æœƒæä¾›å´é‚Šåˆ‡æ›ã€‚</li>
                <li>4. <b>æ‰‹å‹•ä¿®æ­£ï¼š</b>è‹¥ä¸ç¬¦åˆéœ€æ±‚è«‹è‡ªå·±æ‰‹å‹•ç•«ã€‚</li>
            </ul>
        </div>
        
        <div class="card">
            <label>1. é¸æ“‡ç”Ÿæˆæ¨¡å¼ (å¯è¤‡é¸)</label>
            <div id="mode-selection">
                <label class="mode-option"><input type="checkbox" name="pathMode" value="linear" checked> åº§æ¨™ä¸²æ¥ (æ”¶æœ/å¤šå¸³ç¨®èŠ±)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="z-shape"> Zå­—åœ–å½¢ (2åœˆ&é©åˆç¨®è—)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="square"> æ­£æ–¹å½¢è·¯ç·š (2åœˆ&é©åˆç¨®ç™½)</label>
            </div>
        </div>

        <div class="card card-y">
            <label>æä¾›åº§æ¨™</label>
            <select id="sourceType" onchange="toggleSource()" style="width:100%; padding:10px; border-radius:5px;">
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>

        <div id="manualSection" class="card">
            <label>åº§æ¨™è²¼å…¥è™• (ç·¯åº¦, ç¶“åº¦):</label>
            <textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦ (æ¯è¡Œä¸€çµ„)"></textarea>
            <button class="btn-clear" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <div id="fileSection" class="card card-y is-hidden">
            <label>é¸å– GPX æª”æ¡ˆ:</label>
            <input type="file" id="gpxFile" accept=".gpx,.xml" style="width: 100%;">
            <button class="btn-clear" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <button class="btn-gen" onclick="handleProcess()">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
        
        <div id="download-area"></div>
        <div id="status"></div>
    </div>
</div>

<div id="map-container">
    <div id="map-sidebar" class="is-hidden">
        <div class="sidebar-title">åˆ‡æ›é è¦½æ¨¡å¼</div>
        <div id="sidebar-btns"></div>
    </div>
    <div class="map-btn-group">
        <button class="map-ctrl-btn" onclick="toggleMapFullScreen()">å…¨é »/ç¸®å°</button>
        <button class="map-ctrl-btn btn-close-map" onclick="closeMap()">é—œé–‰é è¦½</button>
    </div>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    var map;
    var markerLayer;
    var allLayers = {}; // å„²å­˜å„æ¨¡å¼çš„è»Œè·¡å±¤
    var allPoints = {};  // å„²å­˜å„æ¨¡å¼çš„é»ä½

    function acceptNotice() {
        document.getElementById('bulletin-section').classList.add('is-hidden');
        document.getElementById('generator-section').style.display = 'block';
    }

    function showNotice() {
        document.getElementById('bulletin-section').classList.remove('is-hidden');
        document.getElementById('generator-section').style.display = 'none';
    }

    function toggleSource() {
        const type = document.getElementById('sourceType').value;
        document.getElementById('manualSection').classList.toggle('is-hidden', type !== 'manual');
        document.getElementById('fileSection').classList.toggle('is-hidden', type === 'manual');
    }

    function clearData() {
        document.getElementById('coordInput').value = "";
        document.getElementById('gpxFile').value = "";
        document.getElementById('status').innerText = "è³‡æ–™å·²æ¸…é™¤";
        document.getElementById('download-area').innerHTML = "";
    }

    function openMap() {
        const container = document.getElementById('map-container');
        container.style.display = 'block';
        if (!map) {
            map = L.map('map', { zoomControl: false }).setView([23.5, 121], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        }
        setTimeout(() => map.invalidateSize(), 400);
    }

    function closeMap() {
        document.getElementById('map-container').style.display = 'none';
        document.getElementById('map-container').classList.remove('is-fullscreen');
    }

    function toggleMapFullScreen() {
        const container = document.getElementById('map-container');
        container.classList.toggle('is-fullscreen');
        setTimeout(() => map.invalidateSize(), 400);
    }

    // --- æ ¸å¿ƒè™•ç†é‚è¼¯ ---
    async function handleProcess() {
        const status = document.getElementById('status');
        const sourceType = document.getElementById('sourceType').value;
        const dlArea = document.getElementById('download-area');
        const sidebarBtns = document.getElementById('sidebar-btns');
        const checkedModes = Array.from(document.querySelectorAll('input[name="pathMode"]:checked')).map(el => el.value);

        if (checkedModes.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®ç”Ÿæˆæ¨¡å¼"); return; }
        
        status.innerText = "é‹ç®—ç”Ÿæˆä¸­...";
        dlArea.innerHTML = "";
        sidebarBtns.innerHTML = "";
        allLayers = {};
        allPoints = {};

        try {
            let centers = [];
            if (sourceType === 'manual') {
                const txt = document.getElementById('coordInput').value.trim();
                if (!txt) throw new Error("è«‹å…ˆè²¼å…¥åº§æ¨™è³‡æ–™");
                txt.split('\n').forEach(l => {
                    const p = l.match(/-?\d+\.\d+/g);
                    if (p && p.length >= 2) centers.push([parseFloat(p[1]), parseFloat(p[0])]);
                });
                centers = solveSmoothLoop(centers);
            } else {
                const fileInput = document.getElementById('gpxFile');
                if (fileInput.files.length === 0) throw new Error("è«‹é¸å–æª”æ¡ˆ");
                const xml = await fileInput.files[0].text();
                const regex = /lat=["']([\d.-]+)["']\s+lon=["']([\d.-]+)["']/g;
                let m; while ((m = regex.exec(xml)) !== null) centers.push([parseFloat(m[2]), parseFloat(m[1])]);
            }

            if (centers.length === 0) throw new Error("åº§æ¨™è§£æå¤±æ•—");
            centers = centers.filter((v, i, a) => a.findIndex(t => t[0] === v[0] && t[1] === v[1]) === i);

            openMap();
            if (markerLayer) map.removeLayer(markerLayer);
            markerLayer = L.featureGroup(centers.map(c => 
                L.circleMarker([c[1], c[0]], {radius: 5, color: '#fa5252', fillOpacity: 1}).bindPopup(`${c[1]}, ${c[0]}`)
            )).addTo(map);

            // é‡å°å‹¾é¸çš„æ¨¡å¼åˆ†åˆ¥ç”Ÿæˆ
            checkedModes.forEach((mode, idx) => {
                const points = buildAdaptivePath(centers, mode);
                allPoints[mode] = points;
                
                const layer = L.polyline(points.map(p => [p[1], p[0]]), {color: '#1971c2', weight: 4, opacity: 0.8});
                allLayers[mode] = layer;

                // å»ºç«‹ä¸‹è¼‰æŒ‰éˆ•
                const modeName = getModeLabel(mode);
                const dlBtn = document.createElement('button');
                dlBtn.className = "btn-dl";
                dlBtn.innerText = `ä¸‹è¼‰ã€Œ${modeName}ã€GPX`;
                dlBtn.onclick = () => exportGPX(points, modeName);
                dlArea.appendChild(dlBtn);

                // å»ºç«‹åœ°åœ–å´é‚Šåˆ‡æ›æŒ‰éˆ•
                const sideBtn = document.createElement('button');
                sideBtn.className = "sidebar-btn" + (idx === 0 ? " active" : "");
                sideBtn.innerText = modeName;
                sideBtn.onclick = () => switchPreviewLayer(mode);
                sidebarBtns.appendChild(sideBtn);

                // é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹å‹¾é¸çš„å±¤
                if (idx === 0) layer.addTo(map);
            });

            document.getElementById('map-sidebar').classList.remove('is-hidden');
            map.fitBounds(allLayers[checkedModes[0]].getBounds(), {padding: [40, 40]});
            status.innerText = `æˆåŠŸç”Ÿæˆ ${checkedModes.length} ç¨®è·¯å¾‘ï¼å¯åˆ‡æ›é è¦½æˆ–ä¸‹è¼‰ã€‚`;
        } catch (e) { status.innerText = "éŒ¯èª¤: " + e.message; }
    }

    function getModeLabel(val) {
        if (val === 'linear') return "åº§æ¨™ä¸²æ¥";
        if (val === 'z-shape') return "Zå­—åœ–å½¢";
        return "æ­£æ–¹å½¢è·¯ç·š";
    }

    function switchPreviewLayer(targetMode) {
        // ç§»é™¤æ‰€æœ‰è»Œè·¡å±¤
        Object.values(allLayers).forEach(layer => map.removeLayer(layer));
        // åŠ å…¥ç›®æ¨™å±¤
        allLayers[targetMode].addTo(map);
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
            btn.classList.toggle('active', btn.innerText === getModeLabel(targetMode));
        });
    }

    // --- å¹¾ä½•é‹ç®—æ ¸å¿ƒ ---
    function solveSmoothLoop(pts) {
        if (pts.length < 3) return pts;
        let route = [...pts];
        const center = turf.center(turf.featureCollection(route.map(p => turf.point(p)))).geometry.coordinates;
        route.sort((a, b) => Math.atan2(a[1]-center[1], a[0]-center[0]) - Math.atan2(b[1]-center[1], b[0]-center[0]));
        let improved = true;
        while (improved) {
            improved = false;
            for (let i = 0; i < route.length - 1; i++) {
                for (let j = i + 2; j < route.length; j++) {
                    const d1 = turf.distance(turf.point(route[i]), turf.point(route[i+1])) + turf.distance(turf.point(route[j]), turf.point(route[(j+1)%route.length]));
                    const d2 = turf.distance(turf.point(route[i]), turf.point(route[j])) + turf.distance(turf.point(route[i+1]), turf.point(route[(j+1)%route.length]));
                    if (d2 < d1) {
                        let sub = route.slice(i + 1, j + 1);
                        route.splice(i + 1, j - i, ...sub.reverse());
                        improved = true;
                    }
                }
            }
        }
        return route;
    }

    function buildAdaptivePath(centers, mode) {
        let path = []; const r = 41;
        for (let i = 0; i < centers.length; i++) {
            const curr = centers[i];
            if (mode === 'linear') { path.push(curr); continue; }
            const prev = centers[i === 0 ? centers.length - 1 : i - 1];
            const next = centers[(i + 1) % centers.length];
            const bearing = turf.bearing(turf.point(prev), turf.point(next));
            const cp = turf.point(curr);
            const v = {
                a: turf.destination(cp, r, bearing - 135, {units:'meters'}).geometry.coordinates,
                b: turf.destination(cp, r, bearing - 45, {units:'meters'}).geometry.coordinates,
                c: turf.destination(cp, r, bearing + 45, {units:'meters'}).geometry.coordinates,
                d: turf.destination(cp, r, bearing + 135, {units:'meters'}).geometry.coordinates
            };
            let group = (mode === 'z-shape') ? [v.a, v.b, curr, v.d, v.c] : [v.a, v.b, v.c, v.d, v.a];
            if (path.length > 0) {
                const last = path[path.length - 1];
                if (turf.distance(turf.point(last), turf.point(group[group.length-1])) < turf.distance(turf.point(last), turf.point(group[0]))) group.reverse();
            }
            path.push(...group);
        }
        if (path.length > 0) {
            path = path.filter((v, i, a) => i === 0 || turf.distance(turf.point(v), turf.point(a[i-1])) > 0.0001);
            path.push(path[0]);
        }
        return path;
    }

    function exportGPX(pts, name) {
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><trk><name>${name}</name><trkseg>`;
        pts.forEach(pt => gpx += `\n<trkpt lat="${pt[1].toFixed(8)}" lon="${pt[0].toFixed(8)}"></trkpt>`);
        gpx += `\n</trkseg></trk></gpx>`;
        const blob = new Blob([gpx], { type: 'application/gpx+xml' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `pikmin_${name}_${Date.now()}.gpx`; a.click();
    }
</script>
</body>
</html>
