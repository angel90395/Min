<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>çš®å…‹æ•ç¨®èŠ±è·¯å¾‘ç”Ÿæˆä¿®æ”¹å™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --p-green: #2f9e44; --p-blue: #1971c2; --p-orange: #f08c00; --p-red: #e03131; --p-dark: #343a40; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f8f9fa; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; overflow: hidden; }
        
        /* é¸å–®ç³»çµ± */
        #side-menu { position: fixed; top: 0; left: -260px; width: 260px; height: 100%; background: white; z-index: 10005; transition: 0.3s; box-shadow: 2px 0 15px rgba(0,0,0,0.2); padding-top: 70px; }
        #side-menu.open { left: 0; }
        .menu-item { padding: 18px 25px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; color: var(--p-dark); font-size: 15px; }
        .menu-item:active { background: #f1f3f5; color: var(--p-green); }
        #menu-btn { position: fixed; top: 15px; left: 15px; z-index: 10006; background: white; border: 2px solid var(--p-green); border-radius: 10px; padding: 8px 12px; cursor: pointer; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* ä¸»ä½ˆå±€ */
        #controls { width: 100%; height: 100%; padding: 20px; padding-top: 80px; padding-bottom: 160px; background: white; z-index: 100; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .is-hidden { display: none !important; }

        #bulletin-section { background: #fff9db; border: 2px solid #fab005; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        #bulletin-section h4 { margin: 0 0 10px 0; color: #d9480f; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }
        
        .instruction-card { background: #e7f5ff; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 6px solid var(--p-blue); }
        .instruction-card p { font-size: 0.85rem; color: #444; margin: 8px 0; line-height: 1.5; font-weight: bold; }

        .card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #dee2e6; border-left: 6px solid var(--p-green); }
        
        /* åœ°åœ–ä»‹é¢ */
        #map-container { position: fixed; bottom: 20px; right: 20px; width: 340px; height: 340px; z-index: 999; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border-radius: 20px; border: 4px solid #fff; overflow: hidden; background: white; transition: 0.3s; }
        #map { width: 100%; height: 100%; }

        textarea { width: 100%; height: 120px; font-size: 16px; border: 1.5px solid #ced4da; border-radius: 8px; padding: 12px; }
        button.main-btn { width: 100%; padding: 20px; margin: 10px 0; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: 0.2s; }
        button.main-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>

<button id="menu-btn" onclick="toggleMenu()">â˜°</button>
<div id="side-menu">
    <div class="menu-item" onclick="navigate('guideline')">ä½¿ç”¨å®ˆå‰‡</div>
    <div class="menu-item" onclick="navigate('generator')">è·¯å¾‘ç”Ÿæˆå™¨</div>
    <div class="menu-item" onclick="navigate('feedback')">æ„è¦‹åé¥‹</div>
</div>

<div id="controls">
    <h2 id="page-title" style="text-align: center; color: var(--p-green);">ä½¿ç”¨å®ˆå‰‡</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>é€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•é£›äººæ”¶æœã€ç¨®èŠ±çš„ GPX ç”Ÿæˆå™¨ï¼Œä½†è«‹ä¸è¦ç”¨ä¾†ç”¢ç”Ÿåˆ¥äººçš„èŠ±ç”°è·¯å¾‘ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„é£›äººã€‚</p>
        <h4>âš ï¸ è‡ªå¾‹å®ˆå‰‡ï¼š</h4>
        <ul>
            <li>1. æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸å ç‚ºå·±ç”¨</li>
            <li>2. æœ‰é–‹èŠ±çš„ç”° åƒ…ç”Ÿæˆæ”¶æœè·¯ç·š</li>
            <li>3. æª”æ¡ˆè«‹è‡ªç”¨ï¼Œä¸è¦åˆ†äº«ã€‚</li>
        </ul>
        <button class="main-btn" style="background:var(--p-green)" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="main-generator-area" class="is-hidden">
        <div class="instruction-card">
            <h4>ğŸ“¢ ä½¿ç”¨èªªæ˜èˆ‡æé†’</h4>
            <p>æ‰‹å‹•è¼¸å…¥ï¼šå¡«å…¥èŠ±è‹—çš„åº§æ¨™ï¼Œï¼ˆç·¯åº¦,ç¶“åº¦ï¼‰ä¸€è¡Œä¸€å€‹</p>
            <p>ä¸Šå‚³GPXæª”æ¡ˆï¼šå¯ä»¥ä¸Šå‚³ç›®å‰å·²æœ‰çš„èŠ±è‹—ä¸²æ¥è·¯å¾‘ç›´æ¥ç”Ÿæˆå…¶ä»–åœ–å½¢è·¯å¾‘</p>
            <p>ç”Ÿæˆè·¯å¾‘ä¸¦é è¦½åœ°åœ–ï¼šæœƒé€²å…¥åˆ°åœ°åœ–é è¦½æ¨¡å¼ï¼Œå¯ä»¥èª¿æ•´é †åºæˆ–åœ–å½¢è·¯å¾‘çš„æ–¹å‘</p>
            <p>ç›´æ¥ç”Ÿæˆä¸‹è¼‰ï¼šé è¨­æœ€çŸ­è·¯å¾‘ç›´æ¥ä¸‹è¼‰GPX</p>
        </div>
        
        <div class="card" style="border-left-color: #fcc419;">
            <select id="sourceType" onchange="toggleSource()" style="width:100%; padding:15px; border-radius:10px;">
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>

        <div id="fileSection" class="card is-hidden" style="border-left-color: #fcc419;">
            <input type="file" id="gpxFile" accept=".gpx, .GPX, .xml, text/xml, application/xml, application/gpx+xml" style="width: 100%; padding: 10px;">
        </div>

        <div id="manualSection" class="card">
            <textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦ (ä¾‹å¦‚: 25.033, 121.565)"></textarea>
        </div>

        <button class="main-btn" style="background:var(--p-green)" onclick="processAll(true)">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
    </div>

    <div id="feedback-area" class="is-hidden">
        <div class="card" style="min-height: 600px; border-left-color: var(--p-orange); padding: 5px;">
            <iframe data-tally-src="https://tally.so/embed/ä½ çš„è¡¨å–®ID?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="600" frameborder="0" title="æ„è¦‹åé¥‹"></iframe>
        </div>
    </div>
</div>

<div id="map-container">
    <div id="map"></div>
    <div style="position: absolute; bottom: 30px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px;">
        <button class="main-btn" style="background:var(--p-green); padding: 15px 25px; margin:0;" onclick="downloadActive()">å„²å­˜ä¸‹è¼‰</button>
        <button class="main-btn" style="background:var(--p-red); padding: 15px 25px; margin:0;" onclick="closeMap()">é—œé–‰é è¦½</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script async src="https://tally.so/widgets/embed.js"></script>

<script>
    var map, currentData = [], markers = [];

    // é¸å–®å°èˆªé‚è¼¯ï¼šç¢ºä¿æ­£ç¢ºåˆ‡æ›é¡¯ç¤ºç‹€æ…‹
    function navigate(v) {
        if (document.getElementById('side-menu').classList.contains('open')) toggleMenu();
        
        const titleEl = document.getElementById('page-title');
        const sections = {
            'guideline': { id: 'bulletin-section', title: 'ä½¿ç”¨å®ˆå‰‡' },
            'generator': { id: 'main-generator-area', title: 'è·¯å¾‘ç”Ÿæˆå™¨' },
            'feedback': { id: 'feedback-area', title: 'æ„è¦‹åé¥‹' }
        };

        // å…ˆéš±è—æ‰€æœ‰å€åŸŸ
        Object.values(sections).forEach(s => {
            const el = document.getElementById(s.id);
            if (el) el.classList.add('is-hidden');
        });

        // é¡¯ç¤ºç›®æ¨™å€åŸŸ
        if (sections[v]) {
            document.getElementById(sections[v].id).classList.remove('is-hidden');
            titleEl.innerText = sections[v].title;
        }
    }

    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }
    function acceptNotice() { navigate('generator'); }
    function toggleSource() {
        const isFile = document.getElementById('sourceType').value === 'file';
        document.getElementById('fileSection').classList.toggle('is-hidden', !isFile);
        document.getElementById('manualSection').classList.toggle('is-hidden', isFile);
    }
    function closeMap() { document.getElementById('map-container').style.display = 'none'; }

    // è§£æèˆ‡åœ°åœ–é‚è¼¯ (åŒ…å« iOS DOMParser ä¿®æ­£)
    async function processAll(preview) {
        let centers = [];
        if(document.getElementById('sourceType').value === 'file') {
            const f = document.getElementById('gpxFile').files[0];
            if(!f) return alert("è«‹é¸å–æª”æ¡ˆ");
            const xmlText = await f.text();
            const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
            const points = xmlDoc.querySelectorAll('trkpt, rtept');
            points.forEach(p => {
                const lat = parseFloat(p.getAttribute('lat'));
                const lon = parseFloat(p.getAttribute('lon'));
                if(!isNaN(lat) && !isNaN(lon)) centers.push({ lat, lng: lon });
            });
        } else {
            const matches = document.getElementById('coordInput').value.match(/-?\d+\.\d+/g);
            if(matches) for(let i=0; i<matches.length; i+=2) centers.push({lat:parseFloat(matches[i]), lng:parseFloat(matches[i+1])});
        }

        if(centers.length === 0) return alert("æ‰¾ä¸åˆ°é»ä½");
        currentData = centers;
        
        document.getElementById('map-container').style.display = 'block';
        if (!map) {
            map = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        map.setView([centers[0].lat, centers[0].lng], 14);
        setTimeout(() => { map.invalidateSize(true); }, 300);
    }

    // ä¸‹è¼‰é‚è¼¯ (åŒ…å«ç¾©å¤§åˆ©è­¯åä¿®æ­£èˆ‡éš¨æ©Ÿç¢¼)
    async function downloadActive() {
        const now = new Date();
        const dStr = now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0');
        const rand = Math.random().toString(36).substr(2, 5);
        let c_en = "Area", c_zh = "åœ‹å®¶";

        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentData[0].lat}&lon=${currentData[0].lng}&accept-language=zh-TW`);
            const data = await res.json();
            c_zh = (data.address.country || "æœªçŸ¥").replace('æ„å¤§åˆ©', 'ç¾©å¤§åˆ©');
            const resEn = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentData[0].lat}&lon=${currentData[0].lng}&accept-language=en`);
            const dataEn = await resEn.json();
            c_en = (dataEn.address.country || "Unknown").replace(/\s+/g, '');
        } catch(e) {}

        const fileName = `pikmingpx_linear_${currentData.length}è‹—_${c_en}_${c_zh}_${dStr}_${rand}.gpx`;
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><trk><name>çš®å…‹æ•è·¯å¾‘_${c_zh}</name><trkseg>`;
        currentData.forEach(p => gpx += `\n<trkpt lat="${p.lat.toFixed(8)}" lon="${p.lng.toFixed(8)}"></trkpt>`);
        gpx += `\n</trkseg></trk></gpx>`;

        const blob = new Blob([gpx], { type: 'application/gpx+xml' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
    }
</script>
</body>
</html>
