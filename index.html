<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>çš®å…‹æ•ç¨®èŠ±æ”¶æœè·¯å¾‘ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f0f4f8; overflow-x: hidden; }
        body { display: flex; flex-direction: column; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; }

        #controls { width: 100%; min-height: 100vh; padding: 15px; background: white; z-index: 100; overflow-y: auto; }
        .is-hidden { display: none !important; }

        /* å…¬å‘Šæ¬„ */
        #bulletin-section { background: #fff9db; border: 1px solid #fab005; border-radius: 12px; padding: 20px; margin-bottom: 15px; font-size: 0.95rem; color: #444; line-height: 1.7; }
        #bulletin-section h4 { margin: 15px 0 8px 0; color: #d9480f; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }

        #generator-section { display: none; }
        .instruction-card { background: #e7f5ff; border: 1px solid #a5d8ff; border-radius: 10px; padding: 15px; margin-bottom: 15px; font-size: 0.9rem; color: #1864ab; }

        /* æ¨¡å¼é¸æ“‡ */
        .mode-option { display: flex; align-items: center; background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #dee2e6; cursor: pointer; }
        .mode-option input { margin-right: 12px; width: 22px; height: 22px; }

        /* åœ°åœ–å®¹å™¨ */
        #map-container { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 320px; z-index: 999; display: none; box-shadow: 0 4px 25px rgba(0,0,0,0.4); border-radius: 15px; border: 3px solid #fff; overflow: hidden; }
        #map-container.is-fullscreen { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; border: none; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* åœ°åœ–æ§åˆ¶æŒ‰éˆ• */
        .map-btn-group { position: absolute; top: 100px; right: 15px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .map-ctrl-btn { background: rgba(33, 37, 41, 0.9); color: white; border: none; padding: 10px 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px; }

        /* åºè™Ÿæ¨™ç±¤ï¼šåŠ å¤§ä¸”æ–‡å­—ç½®ä¸­ */
        .number-icon {
            background: #fa5252; border: 2.5px solid white; border-radius: 50%;
            color: white; font-weight: 800; text-align: center;
            font-size: 14px; width: 32px !important; height: 32px !important;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .number-icon.selected { background: #2f9e44; transform: scale(1.15); z-index: 1000 !important; }
        .number-icon.picking { background: #adb5bd; border-color: #666; }

        /* è·é›¢çµ±è¨ˆé¢æ¿ï¼šä½æ–¼å´é‚Šé¸é …ä¸Šæ–¹ */
        #stat-panel {
            background: rgba(33, 37, 41, 0.9); padding: 8px 12px; border-radius: 8px;
            color: white; margin-bottom: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .stat-line { font-size: 11px; margin: 2px 0; font-weight: bold; white-space: nowrap; }

        /* å´é‚Šåˆ‡æ›é¸å–®åŒ…è£¹å±¤ */
        #map-sidebar-wrapper { position: absolute; top: 120px; left: 10px; z-index: 2000; display: flex; flex-direction: column; width: 160px; }
        #map-sidebar { background: rgba(255,255,255,0.95); border-radius: 8px; padding: 6px; display: flex; flex-direction: column; gap: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .sidebar-btn { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 5px; font-size: 10px; text-align: left; cursor: pointer; }
        .sidebar-btn.active { background: #2f9e44; color: white; border-color: #2f9e44; }

        /* åº•éƒ¨ç·¨è¼¯æ¢ */
        #bottom-editor { position: absolute; bottom: 0; left: 0; width: 100%; background: white; z-index: 10000; border-top: 4px solid #2f9e44; padding: 15px; display: none; flex-direction: column; gap: 8px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); }
        #edit-label { font-size: 12px; font-weight: bold; color: #2f9e44; text-align: center; margin-bottom: 5px; }
        .action-row { display: flex; gap: 6px; justify-content: center; }
        .btn-act { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; }

        .card { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6; border-left: 6px solid #2f9e44; }
        textarea { width: 100%; height: 80px; font-size: 14px; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; }
        button { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; }
        #status { font-size: 13px; color: #fa5252; text-align: center; margin-top: 8px; font-weight: bold; }

        @media (min-width: 768px) { #controls { width: 450px; } #map-container { width: 550px; height: 550px; } #map-sidebar-wrapper { top: 100px; } }
    </style>
</head>
<body id="mainBody">

<div id="controls">
    <h2 style="margin: 0 0 20px; text-align: center; color: #2f9e44;">çš®å…‹æ•ç¨®èŠ±æ”¶æœè·¯å¾‘ç”Ÿæˆå™¨</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>å¤§å®¶éƒ½åœ¨ä¸Šç­ä¹‹é¤˜ç¨®èŠ±è‡ªçµ¦è‡ªè¶³æˆ–æŠ•é¤µæ–°æ‰‹ã€é™¸è»ï¼Œæ²’æœ‰æ™‚é–“ä½¿ç”¨é£›æ©Ÿæ¨¡å¼ç•«è·¯å¾‘ï¼Œé€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•é£›äººæ”¶æœã€ç¨®èŠ±çš„GPXç”Ÿæˆå™¨ï¼Œä½†è«‹ä¸è¦ç”¨ä¾†ç”¢ç”Ÿåˆ¥äººçš„èŠ±ç”°è·¯å¾‘ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„é£›äººã€‚</p>
        <h4>âš ï¸ è«‹éµå®ˆè‡ªå¾‹å®ˆå‰‡ï¼š</h4>
        <ul>
            <li>1.æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸å ç‚ºå·±ç”¨</li>
            <li>2.æœ‰é–‹èŠ±çš„ç”° åƒ…ç”Ÿæˆæ”¶æœè·¯ç·š</li>
            <li>3.ç”¢ç”Ÿçš„æª”æ¡ˆè«‹è‡ªç”¨ï¼Œä¸è¦åˆ†äº«ã€‚</li>
        </ul>
        <button style="background:#2f9e44; color:white; margin-top:10px;" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="generator-section">
        <div class="instruction-card">
            <h4 style="margin:0 0 8px; color:#1971c2">ğŸ“¢ ä½¿ç”¨èªªæ˜èˆ‡æé†’</h4>
            <ol style="margin:0; padding-left:22px; font-size:0.85rem; color:#1864ab; line-height:1.6;">
                <li>æ‰‹å‹•è¼¸å…¥ï¼šå°‡åº§æ¨™ä¾åºè²¼å…¥ï¼Œä¸€è¡Œä¸€å€‹</li>
                <li>ä¸Šå‚³æª”æ¡ˆï¼šå¯ä¸Šå‚³æ—¢æœ‰åªæœ‰èŠ±è‹—åº§æ¨™è·¯å¾‘çš„gpxï¼Œæœƒä¿ç•™åŸæœ¬æª”æ¡ˆçš„è·¯ç·šé †åºã€‚</li>
                <li>åº§æ¨™æŸ¥çœ‹ï¼šé»æ“Šåœ°åœ–çš„ç´…é»å¯é¡¯ç¤ºåº§æ¨™ä¸¦é€²è¡Œè·¯ç·šæ–¹å‘å¾®èª¿ä¿®æ”¹</li>
                <li>ç”Ÿæˆå™¨åƒ…ä¾›æ–¹ä¾¿ä½¿ç”¨ï¼Œç„¡æ³•æ»¿è¶³å¤§å®¶æ‰€æœ‰çš„è·¯ç·šéœ€æ±‚ï¼Œç”Ÿæˆçš„è·¯å¾‘å¦‚æœ‰ä¸æ»¿æ„ï¼Œè«‹åˆ°å…¶ä»–è»Ÿé«”é‡æ–°ç¹ªè£½ã€‚</li>
            </ol>
        </div>
        
        <div class="card">
            <label style="font-weight:bold; margin-bottom:8px; display:block;">1. é¸æ“‡ç”Ÿæˆæ¨¡å¼ (å¯è¤‡é¸)</label>
            <div>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="linear" checked> èŠ±è‹—åº§æ¨™ä¸²é€£(é©åˆæ”¶æœ)</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="z-shape"> Zå­—åœ–å½¢</label>
                <label class="mode-option"><input type="checkbox" name="pathMode" value="s-shape"> Så‹åœ–å½¢(ç¨®å®Œä¸€åœˆç´„å‰©113-129èŠ±ç“£)</label>
            </div>
        </div>

        <div class="card" style="border-left-color: #fcc419;">
            <label style="font-weight:bold; margin-bottom:5px; display:block;">æä¾›åº§æ¨™</label>
            <select id="sourceType" onchange="toggleSource()" style="width:100%; padding:10px;">
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>

        <div id="manualSection" class="card">
            <textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦ (æ¯è¡Œä¸€çµ„)"></textarea>
            <button style="background:#f08c00; color:white" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <div id="fileSection" class="card is-hidden" style="border-left-color: #fcc419;">
            <input type="file" id="gpxFile" accept=".gpx,.xml" style="width: 100%;">
            <button style="background:#f08c00; color:white" onclick="clearData()">æ¸…é™¤æ‰€æœ‰è¼¸å…¥è³‡æ–™</button>
        </div>

        <button style="background:#2f9e44; color:white" onclick="processAll(true)">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
        <button style="background:#1971c2; color:white;" onclick="processAll(false)">ç›´æ¥ç”Ÿæˆ ä¸‹è¼‰GPX</button>
        <button style="background:#f8f9fa; color:#495057; border:1px solid #ddd;" onclick="showNotice()">æŸ¥çœ‹ç”¨é€”å®ˆå‰‡</button>
        <div id="status"></div>
    </div>
</div>

<div id="map-container">
    <div id="map-sidebar-wrapper" class="is-hidden">
        <div id="stat-panel">
            <div class="stat-line" id="dist-val">ç¸½è·é›¢ï¼š0.00 km</div>
            <div class="stat-line" id="time-val">æ™‚é–“ï¼š0 min (20km/h)</div>
        </div>
        <div id="map-sidebar">
            <div id="sidebar-btns"></div>
        </div>
    </div>

    <div class="map-btn-group">
        <button class="map-ctrl-btn" id="btn-pick-order" style="background:#fcc419; color:#333" onclick="togglePickingMode()">ğŸ‘† è‡ªé¸é †åº</button>
        <button class="map-ctrl-btn" onclick="toggleMapFullScreen()">å…¨é »/ç¸®å°</button>
        <button class="map-ctrl-btn" style="background:#2f9e44" onclick="downloadActive()">å„²å­˜ç·¨è¼¯ä¸¦ä¸‹è¼‰</button>
        <button class="map-ctrl-btn" style="background:#e03131" onclick="closeMap()">é—œé–‰é è¦½</button>
    </div>
    <div id="map"></div>

    <div id="bottom-editor">
        <div id="edit-label">æ­£åœ¨ç·¨è¼¯ç¬¬ 1 çµ„</div>
        <div class="action-row">
            <button class="btn-act" style="background:#e7f5ff; color:#1971c2" onclick="moveSequence(-1)">â¬† å‰ç§»åºè™Ÿ</button>
            <button class="btn-act" style="background:#e7f5ff; color:#1971c2" onclick="moveSequence(1)">â¬‡ å¾Œç§»åºè™Ÿ</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="rotatePoint(45)">â†» æ—‹è½‰åœ–å½¢</button>
        </div>
        <div class="action-row">
            <button class="btn-act" style="background:#e7f5ff; color:#1971c2" onclick="cycleOffset()">ğŸ“ ä¿®æ”¹éŠœæ¥å…¥å£</button>
            <button class="btn-act" style="background:#fd7e14; color:white" onclick="restoreGlobalOriginal()">â® æ¢å¾©åŸå§‹</button>
            <button class="btn-act" style="background:#e03131; color:white" onclick="deletePoint()">ğŸ—‘ï¸ åˆªé™¤çµ„</button>
            <button class="btn-act" style="background:#adb5bd; color:white" onclick="closeEditor()">å®Œæˆ</button>
        </div>
    </div>
</div
