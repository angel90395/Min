<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>çš®å…‹æ•æ”¶æœç¨®èŠ±è·¯å¾‘ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f0f4f8; overflow-x: hidden; }
        body { display: flex; flex-direction: column; font-family: -apple-system, "å¾®è»Ÿæ­£é»‘é«”", sans-serif; }
        #controls { width: 100%; min-height: 100vh; padding: 15px; background: white; z-index: 100; overflow-y: auto; }
        .is-hidden { display: none !important; }
        
        #bulletin-section { background: #fff9db; border: 1px solid #fab005; border-radius: 12px; padding: 20px; margin-bottom: 15px; font-size: 0.95rem; color: #444; line-height: 1.7; }
        #bulletin-section h4 { margin: 15px 0 8px 0; color: #d9480f; border-bottom: 2px solid #ffe066; padding-bottom: 5px; }
        #bulletin-section ul { padding-left: 20px; margin: 10px 0; }
        
        #generator-section { display: none; }
        .card { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #dee2e6; border-left: 6px solid #2f9e44; }
        textarea { width: 100%; height: 80px; font-size: 14px; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; }
        button { width: 100%; padding: 15px; margin: 5px 0; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; }
        
        #map-container { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 320px; z-index: 999; display: none; box-shadow: 0 4px 25px rgba(0,0,0,0.4); border-radius: 15px; border: 3px solid #fff; overflow: hidden; transition: 0.4s ease; }
        #map-container.is-fullscreen { width: 100vw; height: 100vh; bottom: 0; right: 0; border-radius: 0; border: none; }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        .map-btn-group { position: absolute; top: 10px; right: 10px; z-index: 2010; display: flex; flex-direction: column; gap: 8px; }
        .map-ctrl-btn { background: rgba(33, 37, 41, 0.9); color: white; border: none; padding: 10px 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        
        /* çµ±è¨ˆé¢æ¿ï¼šèª¿æ•´ z-index ç¢ºä¿åœ¨å…¨è¢å¹•ä¸‹ä¸è¢«é®æ“‹ */
        #stat-panel { position: absolute; top: 10px; left: 10px; z-index: 2010; background: rgba(255,255,255,0.95); padding: 8px 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); border-left: 5px solid #1971c2; pointer-events: none; }
        .stat-line { font-size: 12px; color: #333; margin: 2px 0; font-weight: bold; display: block; }
        
        #map-sidebar { position: absolute; top: 80px; left: 10px; z-index: 2000; background: rgba(255,255,255,0.95); border-radius: 8px; padding: 6px; display: flex; flex-direction: column; gap: 4px; width: 110px; }
        .sidebar-btn { background: #fff; border: 1px solid #ddd; padding: 6px; border-radius: 4px; font-size: 11px; text-align: left; cursor: pointer; }
        .sidebar-btn.active { background: #2f9e44; color: white; border-color: #2b8a3e; }
        
        #bottom-editor { position: absolute; bottom: 0; left: 0; width: 100%; background: white; z-index: 10000; border-top: 4px solid #2f9e44; padding: 12px; display: none; flex-direction: column; gap: 6px; box-shadow: 0 -5px 15px rgba(0,0,0,0.15); }
        .action-row { display: flex; gap: 5px; justify-content: center; }
        .btn-act { flex: 1; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; }
        .number-icon { background: #fa5252; border: 2px solid white; border-radius: 50%; color: white; font-weight: 800; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .number-icon.selected { background: #2f9e44; transform: scale(1.1); }
    </style>
</head>
<body>

<div id="controls">
    <h2 style="margin: 0 0 20px; text-align: center; color: #2f9e44;">çš®å…‹æ•æ”¶æœç¨®èŠ±è·¯å¾‘ç”Ÿæˆå™¨</h2>
    
    <div id="bulletin-section">
        <h4>ğŸ“¢ ç”Ÿæˆå™¨çš„ç”¨é€”èˆ‡ç›®çš„</h4>
        <p>å¤§å®¶éƒ½åœ¨ä¸Šç­ä¹‹é¤˜ç¨®èŠ±è‡ªçµ¦è‡ªè¶³æˆ–æŠ•é¤µæ–°æ‰‹ã€é™¸è»ï¼Œæ²’æœ‰æ™‚é–“ä½¿ç”¨é£›æ©Ÿæ¨¡å¼ç•«è·¯å¾‘ï¼Œé€™æ˜¯ä¸€å€‹æ–¹ä¾¿çš®å…‹æ•é£›äººæ”¶æœã€ç¨®èŠ±çš„GPXç”Ÿæˆå™¨ï¼Œä½†è«‹ä¸è¦ç”¨ä¾†ç”¢ç”Ÿåˆ¥äººçš„èŠ±ç”°è·¯å¾‘ï¼Œè«‹è‡ªå¾‹ç•¶ä¸€å€‹å‹å–„çš„é£›äººã€‚</p>
        <h4>âš ï¸ è«‹éµå®ˆè‡ªå¾‹å®ˆå‰‡ï¼š</h4>
        <ul>
            <li>1. æœ‰èŠ±ç—•çš„ç”° ä¸é–‹ç™¼ ä¸å ç‚ºå·±ç”¨</li>
            <li>2. æœ‰é–‹èŠ±çš„ç”° åƒ…ç”Ÿæˆæ”¶æœè·¯ç·š</li>
            <li>3. ç”¢ç”Ÿçš„æª”æ¡ˆè«‹è‡ªç”¨ï¼Œä¸è¦åˆ†äº«ã€‚</li>
        </ul>
        <button style="background:#2f9e44; color:white; width:100%;" onclick="acceptNotice()">å¥½çš„ï¼Œæˆ‘é¡˜æ„éµå®ˆä¸¦ç†è§£</button>
    </div>

    <div id="generator-section">
        <div class="card">
            <label style="font-weight:bold; display:block; margin-bottom:8px;">1. é¸æ“‡ç”Ÿæˆæ¨¡å¼ (å¯è¤‡é¸)</label>
            <div id="mode-list">
                <label style="display:flex; align-items:center; margin-bottom:5px;"><input type="checkbox" name="pathMode" value="linear" checked style="width:20px;height:20px;margin-right:10px;"> åº§æ¨™ä¸²æ¥(ç¹åœˆ)</label>
                <label style="display:flex; align-items:center; margin-bottom:5px;"><input type="checkbox" name="pathMode" value="z-shape" style="width:20px;height:20px;margin-right:10px;"> Zå­—åœ–å½¢</label>
                <label style="display:flex; align-items:center; margin-bottom:5px;"><input type="checkbox" name="pathMode" value="s-shape" style="width:20px;height:20px;margin-right:10px;"> Så‹åœ–å½¢</label>
                <label style="display:flex; align-items:center; margin-bottom:5px;"><input type="checkbox" name="pathMode" value="bowtie" style="width:20px;height:20px;margin-right:10px;"> è´è¶çµåœ–å½¢</label>
                <label style="display:flex; align-items:center; margin-bottom:5px;"><input type="checkbox" name="pathMode" value="pulse" style="width:20px;height:20px;margin-right:10px;"> ç”Ÿå‘½æ³¢å‹•åœ–å½¢</label>
            </div>
        </div>
        <div class="card">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">æä¾›åº§æ¨™</label>
            <select id="sourceType" onchange="toggleSource()" style="width:100%; padding:8px;">
                <option value="manual">æ‰‹å‹•è²¼ä¸Šåº§æ¨™</option>
                <option value="file">ä¸Šå‚³ GPX æª”æ¡ˆ</option>
            </select>
        </div>
        <div id="manualSection" class="card"><textarea id="coordInput" placeholder="ç·¯åº¦, ç¶“åº¦ (æ¯è¡Œä¸€å€‹)"></textarea></div>
        <div id="fileSection" class="card is-hidden"><input type="file" id="gpxFile" accept=".gpx,.xml"></div>
        <button style="background:#2f9e44; color:white;" onclick="processAll(true)">ç”Ÿæˆè·¯å¾‘ ä¸¦ é è¦½åœ°åœ–</button>
        <button style="background:#1971c2; color:white;" onclick="processAll(false)">ç›´æ¥ç”Ÿæˆ ä¸‹è¼‰GPX</button>
    </div>
</div>

<div id="map-container">
    <div id="stat-panel">
        <div class="stat-line" id="dist-val">ç¸½è·é›¢ï¼š0.00 km</div>
        <div class="stat-line" id="time-val">é è¨ˆæ™‚é–“ï¼š0 min</div>
    </div>
    <div id="map-sidebar" class="is-hidden"><div id="sidebar-btns"></div></div>
    <div class="map-btn-group">
        <button class="map-ctrl-btn" onclick="toggleMapFullScreen()">å…¨è¢å¹•/ç¸®å°</button>
        <button class="map-ctrl-btn" style="background:#2f9e44" onclick="downloadActive()">ä¸‹è¼‰GPX</button>
        <button class="map-ctrl-btn" style="background:#f03e3e" onclick="resetToRaw()">å…¨é¢æ¢å¾©</button>
        <button class="map-ctrl-btn" style="background:#e03131" onclick="closeMap()">é—œé–‰</button>
    </div>
    <div id="map"></div>
    <div id="bottom-editor">
        <div id="edit-info" style="font-size:12px; text-align:center; padding:6px; background:#f8f9fa; border-radius:6px; margin-bottom:8px;">
            <span id="edit-label" style="font-weight:bold; color:#2f9e44;">æ­£åœ¨ç·¨è¼¯ç¬¬ 1 çµ„</span> : 
            <span id="coord-display" style="font-family: monospace; color:#333;">0.000000, 0.000000</span>
        </div>
        <div class="action-row">
            <button class="btn-act" style="background:#e7f5ff; color:#1971c2" onclick="moveSequence(-1)">â¬† å‰ç§»</button>
            <button class="btn-act" style="background:#e7f5ff; color:#1971c2" onclick="moveSequence(1)">â¬‡ å¾Œç§»</button>
            <button class="btn-act" style="background:#f1f3f5" onclick="rotatePoint(45)">â†» æ—‹è½‰</button>
        </div>
        <div class="action-row">
            <button class="btn-act" style="background:#fd7e14; color:white" onclick="restoreCurrent()">â® æ¢å¾©å–®çµ„</button>
            <button class="btn-act" style="background:#e03131; color:white" onclick="deletePoint()">ğŸ—‘ï¸ åˆªé™¤</button>
            <button class="btn-act" style="background:#adb5bd; color:white" onclick="closeEditor()">å®Œæˆ</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    var map, currentData = [], rawBackup = [], activeLayers = {}, markers = [], activeModes = [], editingIdx = -1;

    function acceptNotice() { document.getElementById('bulletin-section').classList.add('is-hidden'); document.getElementById('generator-section').style.display = 'block'; }
    function toggleSource() { const type = document.getElementById('sourceType').value; document.getElementById('manualSection').classList.toggle('is-hidden', type !== 'manual'); document.getElementById('fileSection').classList.toggle('is-hidden', type === 'manual'); }
    function closeMap() { document.getElementById('map-container').style.display = 'none'; closeEditor(); }
    function toggleMapFullScreen() { document.getElementById('map-container').classList.toggle('is-fullscreen'); setTimeout(()=>map.invalidateSize(),400); }
    function closeEditor() { document.getElementById('bottom-editor').style.display = 'none'; editingIdx = -1; refreshPaths(); }

    function openMap() {
        document.getElementById('map-container').style.display = 'block';
        if (!map) { map = L.map('map',{zoomControl:false}); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); L.control.zoom({position:'bottomright'}).addTo(map); }
        setTimeout(() => { map.invalidateSize(); if(currentData.length) map.fitBounds(L.featureGroup(markers).getBounds(), {padding:[50,50]}); }, 300);
    }

    async function processAll(preview) {
        const modes = Array.from(document.querySelectorAll('input[name="pathMode"]:checked')).map(el => el.value);
        if(!modes.length) return alert("è«‹å‹¾é¸æ¨¡å¼");
        try {
            let centers = [];
            if(document.getElementById('sourceType').value === 'manual') {
                const matches = document.getElementById('coordInput').value.match(/-?\d+\.\d+/g);
                for(let i=0; i<matches.length; i+=2) centers.push({lng:parseFloat(matches[i+1]), lat:parseFloat(matches[i]), angle:0});
            } else {
                const xml = await document.getElementById('gpxFile').files[0].text();
                const regex = /lat=["']([\d.-]+)["']\s+lon=["']([\d.-]+)["']/g;
                let m; while((m = regex.exec(xml))!==null) centers.push({lng:parseFloat(m[2]), lat:parseFloat(m[1]), angle:0});
            }
            if(!centers.length) return alert("ç„¡æœ‰æ•ˆåº§æ¨™");
            if (rawBackup.length === 0) rawBackup = JSON.parse(JSON.stringify(centers));
            currentData = centers; activeModes = modes;
            if(!preview) { for(const m of modes) await exportGPX(getFinalPoly(m), m); }
            else { renderEditor(); openMap(); }
        } catch(e) { alert("è®€å–å¤±æ•—"); }
    }

    function resetToRaw() {
        if (!rawBackup.length) return;
        if (confirm("ç¢ºå®šè¦å…¨é¢æ¢å¾©åˆå§‹é»ä½å—ï¼Ÿ")) {
            currentData = JSON.parse(JSON.stringify(rawBackup));
            renderEditor();
        }
    }

    function renderEditor() {
        const sidebar = document.getElementById('sidebar-btns'); sidebar.innerHTML = "";
        document.getElementById('map-sidebar').classList.remove('is-hidden');
        activeModes.forEach((m, i) => {
            activeLayers[m] = L.featureGroup();
            const sBtn = document.createElement('button'); sBtn.className = "sidebar-btn" + (i === 0 ? " active" : "");
            const nameMap = {linear:"ä¸²æ¥", "z-shape":"Zå­—", "s-shape":"Så‹", "bowtie":"è´è¶çµ", "pulse":"ç”Ÿå‘½æ³¢å‹•"};
            sBtn.innerText = nameMap[m] || m;
            sBtn.onclick = () => { Object.values(activeLayers).forEach(lg => lg.remove()); activeLayers[m].addTo(map); document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active')); sBtn.classList.add('active'); closeEditor(); };
            sidebar.appendChild(sBtn);
        });
        Object.values(activeLayers).forEach(lg => lg.remove());
        activeLayers[activeModes[0]].addTo(map);
        refreshPaths();
    }

    function buildGroup(curr, mode) {
        const r = 42.4, rEdge = 30, cp = turf.point([curr.lng, curr.lat]);
        const v = {
            tl: turf.destination(cp, r, curr.angle - 45, {units:'meters'}).geometry.coordinates,
            tr: turf.destination(cp, r, curr.angle + 45, {units:'meters'}).geometry.coordinates,
            ml: turf.destination(cp, rEdge, curr.angle - 90, {units:'meters'}).geometry.coordinates,
            mr: turf.destination(cp, rEdge, curr.angle + 90, {units:'meters'}).geometry.coordinates,
            br: turf.destination(cp, r, curr.angle + 135, {units:'meters'}).geometry.coordinates,
            bl: turf.destination(cp, r, curr.angle - 135, {units:'meters'}).geometry.coordinates
        };
        const Din = turf.destination(cp, rEdge, curr.angle - 180, {units:'meters'}).geometry.coordinates, Dout = turf.destination(cp, rEdge, curr.angle, {units:'meters'}).geometry.coordinates, C = [curr.lng, curr.lat];
        if (mode === 'bowtie') return [Din, C, v.tl, v.tr, C, v.bl, v.br, C, Dout];
        if (mode === 's-shape') return [v.tr, v.tl, v.ml, C, v.mr, v.br, v.bl];
        if (mode === 'z-shape') return [v.bl, v.tl, C, v.br, v.tr];
        if (mode === 'pulse') return [Din, turf.destination(cp, 15, curr.angle - 135, {units:'meters'}).geometry.coordinates, turf.destination(cp, 15, curr.angle - 225, {units:'meters'}).geometry.coordinates, v.ml, v.mr, Dout];
        return [C];
    }

    function refreshPaths() {
        const activeBtn = document.querySelector('.sidebar-btn.active');
        if (!activeBtn) return;
        const mode = activeModes.find(m => activeBtn.innerText.includes(m==='linear'?"ä¸²æ¥":m==='z-shape'?"Zå­—":m==='s-shape'?"Så‹":m==='pulse'?"ç”Ÿå‘½":"è´è¶"));
        const lg = activeLayers[mode]; lg.clearLayers(); markers = [];
        const fullList = [];
        for (let i = 0; i < currentData.length; i++) {
            const group = buildGroup(currentData[i], mode);
            fullList.push(...group);
            const isSel = (editingIdx === i);
            const poly = L.polyline(group.map(p => [p[1], p[0]]), { color: isSel ? '#2f9e44' : '#1971c2', weight: isSel ? 10 : 7 }).addTo(lg);
            poly.on('click', (e) => { L.DomEvent.stopPropagation(e); triggerEdit(i); });
            const icon = L.divIcon({ className: 'number-icon' + (isSel ? ' selected' : ''), html: i + 1, iconSize: [30, 30], iconAnchor: [15, 15] });
            const m = L.marker([currentData[i].lat, currentData[i].lng], { icon: icon }).addTo(lg);
            m.on('click', (e) => { L.DomEvent.stopPropagation(e); triggerEdit(i); });
            markers.push(m);
        }
        if (fullList.length > 1) {
            fullList.push(fullList[0]);
            L.polyline(fullList.map(p => [p[1], p[0]]), { color: '#1971c2', weight: 2, opacity: 0.5 }).addTo(lg);
            const distKM = turf.length(turf.lineString(fullList), {units: 'kilometers'});
            document.getElementById('dist-val').innerText = `ç¸½è·é›¢ï¼š${distKM.toFixed(2)} km`;
            document.getElementById('time-val').innerText = `é è¨ˆæ™‚é–“ï¼š${Math.ceil((distKM/20)*60)} min`;
        }
    }

    function triggerEdit(idx) { 
        editingIdx = idx; 
        document.getElementById('edit-label').innerText = `æ­£åœ¨ç·¨è¼¯ç¬¬ ${idx+1} çµ„`; 
        document.getElementById('coord-display').innerText = `${currentData[idx].lat.toFixed(6)}, ${currentData[idx].lng.toFixed(6)}`;
        document.getElementById('bottom-editor').style.display = 'flex'; 
        refreshPaths(); 
    }
    
    function moveSequence(dir) { if(editingIdx < 0) return; const next = editingIdx + dir; if(next >= 0 && next < currentData.length) { [currentData[editingIdx], currentData[next]] = [currentData[next], currentData[editingIdx]]; triggerEdit(next); } }
    function rotatePoint(v) { if(editingIdx < 0) return; currentData[editingIdx].angle = (currentData[editingIdx].angle + v) % 360; refreshPaths(); }
    function restoreCurrent() { if(editingIdx < 0) return; currentData[editingIdx].angle = 0; refreshPaths(); }
    function deletePoint() { if(editingIdx < 0) return; currentData.splice(editingIdx, 1); closeEditor(); renderEditor(); }
    function getFinalPoly(m) { let path = []; currentData.forEach(curr => path.push(...buildGroup(curr, m))); if (path.length) path.push(path[0]); return path; }
    
    async function downloadActive() {
        const activeBtn = document.querySelector('.sidebar-btn.active');
        if (!activeBtn) return;
        const mKey = activeModes.find(m => activeBtn.innerText.includes(m==='linear'?"ä¸²æ¥":m==='z-shape'?"Zå­—":m==='s-shape'?"Så‹":m==='pulse'?"ç”Ÿå‘½":"è´è¶"));
        await exportGPX(getFinalPoly(mKey), mKey);
    }

    async function exportGPX(pts, modeName) {
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1"><trk><name>${modeName}</name><trkseg>`;
        pts.forEach(pt => gpx += `\n<trkpt lat="${pt[1].toFixed(8)}" lon="${pt[0].toFixed(8)}"></trkpt>`);
        gpx += `\n</trkseg></trk></gpx>`;
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([gpx], { type: 'application/gpx+xml' }));
        a.download = `pikmin_${modeName}_${Date.now()}.gpx`; a.click();
    }
</script>
</body>
</html>
